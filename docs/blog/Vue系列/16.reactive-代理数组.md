## å‰è¨€

ä»æœ¬èŠ‚å¼€å§‹ï¼Œæˆ‘ä»¬è®²è§£å¦‚ä½•ä»£ç†æ•°ç»„ã€‚å®é™…ä¸Šï¼Œåœ¨ JavaScript ä¸­ï¼Œæ•°ç»„åªæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„å¯¹è±¡è€Œå·²ï¼Œå› æ­¤æƒ³è¦æ›´å¥½åœ°å®ç°å¯¹æ•°ç»„çš„ä»£ç†ï¼Œå°±æœ‰å¿…è¦äº†è§£ç›¸æ¯”æ™®é€šå¯¹è±¡ï¼Œæ•°ç»„åˆ°åº•æœ‰ä½•ç‰¹æ®Šä¹‹å¤„ã€‚

## æ•°ç»„å±æ€§çš„"è¯»å–"å’Œ"è®¾ç½®"æ“ä½œ

åœ¨ç¬¬åäºŒç¯‡ä¸­ï¼Œæˆ‘ä»¬æ·±å…¥è®²è§£äº† JavaScript ä¸­çš„å¯¹è±¡ã€‚æˆ‘ä¹ˆä½ æ‰¾ï¼Œåœ¨ JavaScript ä¸­æœ‰ä¸¤ç§å¯¹è±¡: å¸¸è§„å¯¹è±¡å’Œå¼‚è´¨å¯¹è±¡ã€‚æˆ‘ä»¬è¿˜è®¨è®ºäº†ä¸¤è€…çš„å·®å¼‚ã€‚è€Œæœ¬èŠ‚ä¸­æˆ‘ä»¬è¦ä»‹ç»çš„æ•°ç»„å°±æ˜¯ä¸€ä¸ªå¼‚è´¨å¯¹è±¡ï¼Œè¿™æ˜¯å› ä¸ºæ•°ç»„å¯¹è±¡çš„[[DefineOwnProperty]]å†…éƒ¨æ–¹æ³•ä¸å¸¸è§„å¯¹è±¡ä¸åŒã€‚æ¢å¥è¯è¯´ï¼Œæ•°ç»„å¯¹è±¡é™¤äº†[[DefineOwnProperty]]è¿™ä¸ªå†…éƒ¨æ–¹æ³•ä¹‹å¤–ï¼Œå…¶ä»–å†…éƒ¨æ–¹æ³•çš„é€»è¾‘éƒ½ä¸å¸¸è§„å¯¹è±¡ç›¸åŒã€‚å› æ­¤ï¼Œå½“å®ç°å¯¹æ•°ç»„çš„ä»£ç†æ—¶ï¼Œç”¨äºä»£ç†æ™®é€šå¯¹è±¡çš„å¤§éƒ¨åˆ†ä»£ç å¯ä»¥ç»§ç»­ä½¿ç”¨ï¼Œå¦‚ä¸‹æ‰€ç¤º:

```js
const arr = reactive(["foo"])

effect(() => {
	console.log(arr[0]) // 'foo'
})

arr[0] = "bar" // èƒ½å¤Ÿè§¦å‘å“åº”
```

ä¸Šé¢è¿™æ®µä»£ç èƒ½å¤ŸæŒ‰ç…§é¢„æœŸå·¥ä½œã€‚å®é™…ä¸Šï¼Œå½“æˆ‘ä»¬é€šè¿‡ç´¢å¼•è¯»å–æˆ–è¿™æ˜¯æ•°ç»„å…ƒç´ å€¼æ—¶ï¼Œä»£ç†å¯¹è±¡çš„ get/set æ‹¦æˆªå‡½æ•°ä¹Ÿä¼šæ‰§è¡Œï¼Œå› æ­¤æˆ‘ä»¬ä»ä¸éœ€è¦åšä»»ä½•é¢å¤–çš„å·¥ä½œï¼Œå°±èƒ½å¤Ÿè®©æ•°ç»„ç´¢å¼•çš„è¯»å–å’Œè®¾ç½®æ“ä½œæ—¶å“åº”å¼çš„äº†ã€‚

ä½†å¯¹æ•°ç»„çš„æ“ä½œä¸æ™®é€šå¯¹è±¡çš„æ“ä½œä»ç„¶å­˜åœ¨ä¸åŒï¼Œä¸‹é¢æ€»ç»“äº†æ‰€æœ‰å¯¹æ•°ç»„å…ƒç´ æˆ–å±æ€§çš„"è¯»å–"æ“ä½œã€‚

- é€šè¿‡ç´¢å¼•è®¿é—®æ•°ç»„å…ƒç´ å€¼: arr[0]
- è®¿é—®æ•°ç»„çš„é•¿åº¦: arr.length
- æŠŠæ•°ç»„ä½œä¸ºå¯¹è±¡ï¼Œ ä½¿ç”¨ for...in å¾ªç¯éå†
- ä½¿ç”¨ for...of è¿­ä»£éå†æ•°ç»„
- æ•°ç»„çš„åŸå‹æ–¹æ³•ï¼Œå¦‚ concat/join/every/some/find/findIndex/includes ç­‰ï¼Œä»¥åŠå…¶ä»–æ‰€æœ‰ä¸æ”¹å˜åŸæ•°ç»„çš„åŸå‹æ–¹æ³•ã€‚

å¯ä»¥çœ‹åˆ°ï¼Œå¯¹æ•°ç»„çš„è¯»å–æ“ä½œè¦æ¯”æ™®é€šå¯¹è±¡ä¸°å¯Œå¾ˆå¤šã€‚æˆ‘ä»¬åœ¨æ¥çœ‹çœ‹å¯¹æ•°ç»„å…ƒç´ å’Œå±æ€§çš„"è®¾ç½®æ“ä½œ"æœ‰å“ªäº›ã€‚

- é€šè¿‡ç´¢å¼•ä¿®æ”¹æ•°ç»„å…ƒç´ è´¨: arr[1] = 3
- ä¿®æ”¹æ•°ç»„é•¿åº¦: arr.length = 3
- æ•°ç»„çš„æ ˆæ–¹æ³•: push/pop/shift/unshift
- ä¿®æ”¹åŸæ•°ç»„çš„åŸå‹æ–¹æ³•: splice/fill/sort ç­‰

é™¤äº†é€šè¿‡æ•°ç»„ç´¢å¼•ä¿®æ”¹æ•°ç»„å…ƒç´ å€¼è¿™ç§åŸºæœ¬æ“ä½œä¹‹å¤–ï¼Œæ•°ç»„æœ¬èº«è¿˜æœ‰å¾ˆå¤šä¼šä¿®æ”¹åŸæ•°ç»„çš„åŸå‹æ–¹æ³•ã€‚è°ƒç”¨è¿™äº›æ–¹æ³•ä¹Ÿå±äºå¯¹æ•°ç»„çš„æ“ä½œï¼Œæœ‰äº›æ–¹æ³•çš„æ“ä½œè¯­ä¹‰æ˜¯"è¯»å–",è€Œæœ‰äº›æ–¹æ³•çš„æ“ä½œè¯­ä¹‰æ˜¯"è®¾ç½®"ã€‚å› æ­¤ï¼Œå½“è¿™äº›æ“ä½œå‘ç”Ÿæ—¶ï¼Œä¹Ÿåº”è¯¥æ­£ç¡®åœ°å»ºç«‹å“åº”è”ç³»æˆ–è§¦å‘å“åº”ã€‚

ä»ä¸Šé¢åˆ—å‡ºçš„è¿™äº›å¯¹æ•°ç»„çš„æ“ä½œæ¥çœ‹ï¼Œä¼¼ä¹ä»£ç†æ•°ç»„çš„éš¾åº¦è¦æ¯”ä»£ç†æ™®é€šå¯¹è±¡çš„éš¾åº¦å¤§å¾ˆå¤šã€‚ä½†äº‹å®å¹¶éå¦‚æ­¤ï¼Œè¿™æ˜¯å› ä¸ºæ•°ç»„æœ¬èº«ä¹Ÿæ˜¯å¯¹è±¡ï¼Œåªä¸è¿‡ä»–æ˜¯å¼‚è´¨å¯¹è±¡ç½¢äº†ï¼Œå®ƒä¸å¸¸è§„å¯¹è±¡çš„å·®å¼‚å¹¶ä¸å¤§ã€‚å› æ­¤å¤§éƒ¨åˆ†ç”¨æ¥ä»£ç†å¸¸è§„å¯¹è±¡çš„ä»£ç å¯¹äºæ•°ç»„ä¹Ÿæ˜¯ç”Ÿæ•ˆçš„ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±ä»é€šè¿‡ç´¢å¼•è¯»å–æˆ–è®¾ç½®æ•°ç»„çš„å…ƒç´ å€¼è¯´èµ·ã€‚

## æ•°ç»„çš„ç´¢å¼•ä¸ length

æ‹¿æœ¬èŠ‚å¼€å¤´çš„ä¾‹å­æ¥è¯´ï¼Œå½“é€šè¿‡æ•°ç»„çš„ç´¢å¼•è®¿é—®å…ƒç´ çš„å€¼æ—¶ï¼Œå·²ç»èƒ½å¤Ÿå»ºç«‹ç›¸åº”è”ç³»äº†:

```js
const arr = reactive(["foo"])

effect(() => {
	console.log(arr[0]) // 'foo'
})

arr[0] = "bar" // è§¦å‘å“åº”
```

ä½†é€šè¿‡ç´¢å¼•è®¾ç½®æ•°ç»„çš„å…ƒç´ å€¼ä¸è®¾ç½®å¯¹è±¡çš„å±æ€§å€¼ä»ç„¶å­˜åœ¨æ ¹æœ¬ä¸Šçš„ä¸åŒï¼Œè¿™æ˜¯å› ä¸ºæ•°ç»„å¯¹è±¡éƒ¨ç½²çš„å†…éƒ¨æ–¹æ³•[[DefineOwnProperty]]ä¸åŒäºè§„å¯¹è±¡ã€‚å®é™…ä¸Šï¼Œå½“æˆ‘ä»¬é€šè¿‡ç´¢å¼•è®¾ç½®æ•°ç»„å…ƒç´ çš„å€¼æ—¶ï¼Œä¼šæ‰§è¡Œæ•°ç»„å¯¹è±¡æ‰€éƒ¨ç½²é¢å†…éƒ¨æ–¹æ³•[[Set]],è¿™ä¸€æ­¥ä¸è®¾ç½®å¸¸è§„å¯¹è±¡çš„å±æ€§å€¼ä¸€æ ·ã€‚æ ¹æ®è§„èŒƒå¯çŸ¥ï¼Œå†…éƒ¨æ–¹æ³•[[Set]]å…¶å®ä¾èµ–äº[[DefineOwnProperty]],åˆ°äº†è¿™é‡Œå°±æç°äº†å‡ºäº†å·®å¼‚ã€‚æ•°ç»„å¯¹è±¡çš„æ‰€éƒ¨ç½²çš„å†…éƒ¨æ–¹æ³•[[DefineOwnProperty]]çš„é€»è¾‘å®šä¹‰åœ¨è§„èŒƒçš„ 10.4.2.1 èŠ‚ï¼Œå¦‚å›¾æ‰€ç¤ºã€‚

![img](../assets/VueImage/ECMA-262-array-defineOwnProperty.png)

å›¾ä¸­ç¬¬äºŒæ­¥çš„ j å­æ­¥éª¤æè¿°çš„å†…å®¹å¦‚ä¸‹ã€‚

j. å¦‚æœ index >= oldLen, é‚£ä¹ˆ

        i. å°† oldLenDesc.[[Value]] è®¾ç½®ä¸º index + 1
        ii. è®© succeeded çš„å€¼ä¸º OrdinaryDefineOwnProperty(A,"length",oldLenDesc)
        iii. æ–­è¨€: succeeded æ˜¯ true

å¯ä»¥çœ‹åˆ°ï¼Œè§„èŒƒä¸­æ˜ç¡®è¯´æ˜ï¼Œå¦‚æœè®¾ç½®çš„ç´¢å¼•å€¼å¤§äºæ•°ç»„å½“å‰çš„é•¿åº¦ï¼Œé‚£ä¹ˆè¦æ›´æ–°æ•°ç»„çš„ length å±æ€§ã€‚æ‰€ä»¥å½“é€šè¿‡ç´¢å¼•è®¾ç½®å…ƒç´ å€¼æ—¶ï¼Œå¯èƒ½ä¼šéšå¼åœ°ä¿®æ”¹ length çš„å±æ€§å€¼ã€‚å› æ­¤åœ¨è§¦å‘å“åº”æ—¶ï¼Œä¹Ÿåº”è¯¥è§¦å‘ä¸ length ç›¸å…³è”çš„å‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œï¼Œå¦‚ä¸‹é¢çš„ä»£ç æ‰€ç¤ºï¼š

```js
const arr = reactive(["foo"]) // æ•°ç»„çš„åŸé•¿åº¦ä¸º 1

effect(() => {
	console.log(arr.length) // 1
})

// è®¾ç½®ç´¢å¼• 1 çš„å€¼ï¼Œä¼šå¯¼è‡´æ•°ç»„çš„é•¿åº¦å˜ä¸º 2
arr[1] = "bar"
```

åœ¨è¿™æ®µä»£ç ä¸­ï¼Œæ•°ç»„çš„åŸé•¿åº¦ä¸º 1ï¼Œå¹¶ä¸”åœ¨å‰¯ä½œç”¨å‡½æ•°ä¸­è®¿é—®äº† length å±æ€§ã€‚ç„¶åè®¾ç½®æ•°ç»„ç´¢å¼•ä¸º 1 çš„å…ƒç´ å€¼ï¼Œè¿™ä¼šå¯¼è‡´æ•°ç»„é•¿åº¦å˜ä¸º 2ï¼Œå› æ­¤åº”è¯¥è§¦å‘å‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œã€‚ä½†ç›®å‰çš„å®ç°è¿˜åšä¸åˆ°è¿™ä¸€ç‚¹ï¼Œä¸ºäº†å®ç°ç›®æ ‡ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹ set æ‹¦æˆªå‡½æ•°ï¼Œå¦‚ä¸‹é¢çš„ä»£ç æ‰€ç¤º:

```js
function createReactive(obj, isShallow = false, isReadonly = false) {
	return new Proxy(obj, {
		// æ‹¦æˆªè®¾ç½®æ“ä½œ
		set(target, key, newVal, receiver) {
			if (isReadonly) {
                console.warn(`å±æ€§ ${ key} æ˜¯åªè¯»çš„`)
                return true
			}

            const oldVal = target[key]
            // å¦‚æœä»£ç†ç›®æ ‡æ—¶æ•°ç»„ï¼Œ åˆ™æ£€æµ‹è¢«è®¾ç½®çš„ç´¢å¼•å€¼æ˜¯å¦å°äºæ•°ç»„é•¿åº¦,
            // å¦‚æœæ˜¯ï¼Œåˆ™è§†ä½œ SET æ“ä½œï¼Œ å¦åˆ™æ˜¯ ADD æ“ä½œ
            // å¦‚æœå±æ€§ä¸å­˜åœ¨ï¼Œåˆ™è¯´æ˜æ˜¯åœ¨æ·»åŠ æ–°çš„å±æ€§ï¼Œå¦è€…æ˜¯è®¾ç½®å·²æœ‰å±æ€§
            const type = Array.isArray(target)
            ? Number(key) < target.length : 'SET' : 'ADD'
            : Object.prototype.hasOwnProperty.call(target,key) ? 'SET' : 'ADD'

            const res = Reflect.set(target,key,newVal,receiver)
            if(target === receiver.raw) {
                if(oldVal !== newVal && (oldVal === oldVal || newVal === newVal)) {
                    trigger(target,key,type)
                }
            }

            return true
		}
        // çœç•¥å…¶ä»–æ‹¦æˆªå‡½æ•°
	})
}
```

æˆ‘ä»¬åœ¨åˆ¤æ–­æ“ä½œç±»å‹æ—¶ï¼Œæ–°å¢äº†å¯¹æ•°ç»„ç±»å‹çš„åˆ¤æ–­ã€‚å¦‚æœä»£ç†çš„ç›®æ ‡å¯¹è±¡æ˜¯æ•°ç»„ï¼Œé‚£ä¹ˆå¯¹äºæ“ä½œç±»å‹çš„åˆ¤æ–­ä¼šæœ‰æ‰€åŒºåˆ«ã€‚å³è¢«è®¾ç½®çš„ç´¢å¼•å€¼å¦‚æœå°äºæ•°ç»„é•¿åº¦ï¼Œå°±è§†ä½œ SET æ“ä½œï¼Œå› ä¸ºå®ƒä¸ä¼šæ”¹å˜æ•°ç»„é•¿åº¦ï¼›å¦‚æœè®¾ç½®çš„ç´¢å¼•å€¼å¤§äºæ•°ç»„é•¿åº¦ï¼Œåˆ™è§†ä½œ ADD æ“ä½œï¼Œå› ä¸ºè¿™ä¼šéšå¼åœ°æ”¹å˜æ•°ç»„çš„ length å±æ€§å€¼ã€‚æœ‰äº†è¿™äº›ä¿¡æ¯ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨ trigger å‡½æ•°ä¸­æ­£ç¡®çš„è§¦å‘ä¸æ•°ç»„å¯¹è±¡çš„ length å±æ€§ç›¸å…³è”çš„å‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œäº†:

```js
function trigger(target, key, type) {
	const depsMap = bucket.get(target)
	if (!depsMap) return

	// çœç•¥éƒ¨åˆ†å†…å®¹
	// å½“æ“ä½œç±»å‹ä¸º ADD å¹¶ä¸”ç›®æ ‡å¯¹è±¡æ˜¯æ•°ç»„æ—¶ï¼Œåº”è¯¥å–å‡ºå¹¶æ‰§è¡Œé‚£äº›ä¸ length å±æ€§ç›¸å…³è”çš„å‰¯ä½œç”¨å‡½æ•°
	if (type === "ADD" && Array.isArray(target)) {
		// å–å‡º ä¸ length ç›¸å…³è”çš„å‰¯ä½œç”¨å‡½æ•°
		const lengthEffects = deps.get("length")
		// å°†è¿™äº›å‰¯ä½œç”¨å‡½æ•°æ·»åŠ åˆ° effectsToRun ä¸­ï¼Œå¸¦æ‰§è¡Œ
		lengthEffects &&
			lengthEffects.forEach((effectFn) => {
				if (effectFn !== activeEffect) {
					effectsToRun.add(effectFn)
				}
			})
	}

	effectsToRun.forEach((effectFn) => {
		if (effectFn.options.scheduler) {
			effectFn.options.scheduler(effectFn)
		} else {
			effectFn()
		}
	})
}
```

ä½†æ˜¯åè¿‡æ¥ï¼Œå…¶å®ä¿®æ”¹æ•°ç»„çš„ length å±æ€§ä¹Ÿä¼šéšå¼åœ°å½±å“æ•°ç»„å…ƒç´ ï¼Œä¾‹å¦‚:

```js
const arr = reactive(["foo"])

effect(() => {
	// è®¿é—®æ•°ç»„çš„ç¬¬ 0 ä¸ªå…ƒç´ 
	console.log(arr[0]) // foo
})

// å°†æ•°ç»„çš„é•¿åº¦ä¿®æ”¹ä¸º 0ï¼Œ å¯¼è‡´ç¬¬ 0 ä¸ªå…ƒç´ è¢«åˆ é™¤ï¼Œå› æ­¤åº”è¯¥è§¦å‘å“åº”
arr.length = 0
```

å¦‚ä¸Šé¢ä»£ç æ‰€ç¤ºï¼Œåœ¨å‰¯ä½œç”¨å‡½æ•°å†…è®¿é—®äº†æ•°ç»„çš„ç¬¬ 0 ä¸ªå…ƒç´ ï¼Œæ¥ç€å°†æ•°ç»„çš„ length å±æ€§ä¿®æ”¹ä¸º 0.æˆ‘ä»¬çŸ¥é“è¿™ä¼šéšå¼åœ°å½±å“æ•°ç»„å…ƒç´ ï¼Œå³æ‰€æœ‰å…ƒç´ éƒ½è¢«åˆ é™¤ï¼Œæ‰€ä»¥åº”è¯¥è§¦å‘å‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œã€‚ç„¶è€Œå¹¶éæ‰€æœ‰å¯¹ length å±æ€§çš„ä¿®æ”¹éƒ½ä¼šå½±å“æ•°ç»„ä¸­çš„å·²æœ‰å…ƒç´ ï¼Œæ‹¿ä¸Šä¾‹æ¥è¯´ï¼Œå¦‚æœæˆ‘ä»¬å°† length å±æ€§è®¾ç½®ä¸º 100ï¼Œè¿™å¹¶ä¸ä¼šå½±å“ç¬¬ 0 ä¸ªå…ƒç´ ï¼Œæ‰€ä»¥ä¹Ÿå°±ä¸éœ€è¦è§¦å‘å‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œã€‚è¿™è®©æˆ‘ä»¬æ„è¯†åˆ°ï¼Œå½“ä¿®æ”¹ length å±æ€§æ—¶ï¼Œåªæœ‰é‚£äº›ç´¢å¼•å€¼å¤§äºæˆ–ç­‰äºæ–°çš„ length å±æ€§å€¼çš„å…ƒç´ æ‰éœ€è¦è§¦å‘å“åº”ã€‚ä½†æ— è®ºå¦‚ä½•ï¼Œç›®å‰çš„å®ç°è¿˜åšä¸åˆ°è¿™ä¸€ç‚¹ï¼Œä¸ºäº†å®ç°ç›®æ ‡ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹ set æ‹¦æˆªå‡½æ•°ã€‚åœ¨è°ƒç”¨ trigger å‡½æ•°è§¦å‘å“åº”æ—¶ï¼Œåº”è¯¥æŠŠæ–°çš„å±æ€§å€¼ä¼ é€’è¿‡å»:

```js
function createReactive(obj, isShallow = false, isReadonly = false) {
	return new Proxy(obj, {
		// æ‹¦æˆªè®¾ç½®æ“ä½œ
		set(target, key, newVal, receiver) {
			if (isReadonly) {
                console.warn(`å±æ€§ ${ key} æ˜¯åªè¯»çš„`)
                return true
			}

            const oldVal = target[key]

            const type = Array.isArray(target)
            ? Number(key) < target.length : 'SET' : 'ADD'
            : Object.prototype.hasOwnProperty.call(target,key) ? 'SET' : 'ADD'

            const res = Reflect.set(target,key,newVal,receiver)
            if(target === receiver.raw) {
                if(oldVal !== newVal && (oldVal === oldVal || newVal === newVal)) {
                    // å¢åŠ ç¬¬å››ä¸ªå‚æ•°ï¼Œå³è§¦å‘å“åº”çš„æ–°å€¼
                    trigger(target,key,type,newVal)
                }
            }

            return true
		}
        // çœç•¥å…¶ä»–æ‹¦æˆªå‡½æ•°
	})
}
```

æ¥ç€ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¿®æ”¹ trigger å‡½æ•°:

```js
function trigger(target, key, type, newVal) {
	const depsMap = bucket.get(target)
	if (!depsMap) return
	// çœç•¥å…¶ä»–ä»£ç 
	// å¦‚æœæ“ä½œç›®æ ‡æ—¶æ•°ç»„ï¼Œå¹¶ä¿®æ”¹ä½çš„lengthå±æ€§
	if (Array.isArray(target) && key === "length") {
		// å¯¹äºç´¢å¼•å€¼å¤§äºæˆ–ç­‰äºæ–°çš„ length å€¼çš„å…ƒç´ 
		// éœ€è¦æŠŠæ‰€æœ‰ç›¸å…³è”çš„å‰¯ä½œç”¨å‡½æ•°å–å‡ºå¹¶æ·»åŠ åˆ° effectToRun ä¸­å¾…æ‰§è¡Œ
		depsMap.forEach((effects, key) => {
			if (key >= newVal) {
				effects.forEach((effectFn) => {
					if (effectFn !== activeEffect) {
						effectsToRun.add(effectFn)
					}
				})
			}
		})
	}

	effectToRun.forEach((effectFn) => {
		if (effectFn.options.scheduler) {
			effectFn.options.scheduler(effectFn)
		} else {
			effectFn()
		}
	})
}
```

å¦‚ä¸Šé¢çš„ä»£ç æ‰€ç¤ºï¼Œ ä¸º trigger å‡½æ•°å¢åŠ äº†ç¬¬å››ä¸ªå‚æ•°ï¼Œå³è§¦å‘å“åº”æ—¶çš„æ–°å€¼ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œæ–°å€¼æŒ‡çš„æ˜¯æ–°çš„ length å±æ€§å€¼ï¼Œå®ƒä»£è¡¨æ–°çš„æ•°ç»„é•¿åº¦ã€‚æ¥ç€ï¼Œæˆ‘ä»¬åˆ¤æ–­æ“ä½œçš„ç›®æ ‡æ˜¯å¦æ˜¯æ•°ç»„ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™éœ€è¦æ‰¾åˆ°æ‰€æœ‰ç´¢å¼•å€¼å¤§äºæˆ–ç­‰äºæ–°çš„ length å€¼çš„å…ƒç´ ï¼Œç„¶åæŠŠä¸ä»–ä»¬ç›¸å…³è”çš„å‰¯ä½œç”¨å‡½æ•°å–å‡ºå¹¶æ‰§è¡Œã€‚

## éå†æ•°ç»„

æ—¢ç„¶æ•°ç»„ä¹Ÿæ˜¯å¯¹è±¡ï¼Œ å°±æ„å‘³ç€åŒæ ·å¯ä»¥ä½¿ç”¨ for...in å¾ªç¯éå†:

```js
const arr = reactive(["foo"])

effect(() => {
	for (const key in arr) {
		console.log(key) // 0
	}
})
```

è¿™é‡Œæœ‰å¿…è¦æŒ‡å‡ºä¸€ç‚¹ï¼Œæˆ‘ä»¬åº”è¯¥å°½é‡é¿å…ä½¿ç”¨ for...in å¾ªç¯éå†æ•°ç»„ã€‚ä½†æ—¢ç„¶åœ¨è¯­æ³•ä¸Šæ˜¯å¯è¡Œçš„ï¼Œé‚£ä¹ˆå½“ç„¶ä¹Ÿéœ€è¦è€ƒè™‘ã€‚å‰é¢æˆ‘ä»¬æåˆ°ï¼Œæ•°ç»„å¯¹è±¡å’Œå¸¸è§„å¯¹è±¡çš„ä¸åŒä»…åœ¨[[DefineOwnProperty]]è¿™ä¸ªå†…éƒ¨æ–¹æ³•ä¸Šï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä½¿ç”¨ for...in å¾ªç¯éå†æ•°ç»„ä¸éå†å¸¸è§„å¯¹è±¡å¹¶æ— å·®å¼‚ï¼Œå› æ­¤åŒæ ·å¯ä»¥ä½¿ç”¨ ownKeys æ‹¦æˆªå‡½æ•°è¿›è¡Œæ‹¦æˆªã€‚ä¸‹é¢æ˜¯æˆ‘ä»¬ä¹‹å‰å®ç°çš„ ownKeys æ‹¦æˆªå‡½æ•°:

```js
function createReactive(obj, isShallow = false, isReadonly = false) {
	return new Proxy(obj, {
		// çœç•¥å…¶ä»–æ‹¦æˆªå‡½æ•°
		ownKeys(target) {
			track(target, ITERATE_KEY)
			return Reflect.ownKeys(target)
		}
	})
}
```

è¿™æ®µä»£ç å–è‡ªå‰æ–‡ï¼Œå½“åˆæˆ‘ä»¬ä¸ºäº†è¿½è¸ªå¯¹æ™®é€šå¯¹è±¡çš„ for...in æ“ä½œï¼Œäººä¸ºåˆ›é€ äº† ITERATE_KEY ä½œä¸ºè¿½è¸ªçš„ keyã€‚ä½†è¿™æ˜¯ä¸ºäº†ä»£ç†æ™®é€šå¯¹è±¡è€Œè€ƒè™‘çš„ï¼Œå¯¹äºä¸€ä¸ªæ™®é€šå¯¹è±¡æ¥è¯´ï¼Œåªæœ‰å½“æ·»åŠ æˆ–åˆ é™¤å±æ€§æ—¶æ‰ä¼šå½±å“ for...in å¾ªç¯çš„ç»“æœã€‚æ‰€ä»¥å½“æ·»åŠ æˆ–åˆ é™¤å±æ€§å‘ç”Ÿæ—¶ï¼Œæˆ‘ä»¬éœ€è¦å–å‡ºä¸ ITERATE_KEY ç›¸å…³è”çš„å‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œã€‚ä¸è¿‡ï¼Œå¯¹äºæ•°ç»„æ¥è¯´æƒ…å†µæœ‰æ‰€ä¸åŒï¼Œæˆ‘ä»¬çœ‹çœ‹å“ªäº›æ“ä½œä¼šå½±å“ for...in å¾ªç¯å¯¹æ•°ç»„çš„éå†ã€‚

- æ·»åŠ æ–°å…ƒç´ : arr[100] = 'bar'
- ä¿®æ”¹æ•°ç»„é•¿åº¦: arr.length = 0

å…¶å®ï¼Œæ— è®ºæ˜¯ä¸ºæ•°ç»„æ·»åŠ æ–°å…ƒç´ ï¼Œè¿˜æ˜¯ç›´æ¥ä¿®æ”¹æ•°ç»„çš„é•¿åº¦ï¼Œæœ¬è´¨ä¸Šéƒ½æ˜¯å› ä¸ºä¿®æ”¹äº†æ•°ç»„çš„ length å±æ€§ã€‚ä¸€æ—¦æ•°ç»„çš„ length å±æ€§è¢«ä¿®æ”¹ï¼Œé‚£ä¹ˆ for...in å¾ªç¯å¯¹æ•°ç»„çš„éå†ç»“æœå°±ä¼šæ”¹å˜ï¼Œæ‰€ä»¥åœ¨è¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬åº”è¯¥è§¦å‘å“åº”ã€‚å¾ˆè‡ªç„¶çš„ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ ownKeys æ‹¦æˆªå‡½æ•°å†…ï¼Œåˆ¤æ–­å½“å‰æ“ä½œç›®æ ‡ target æ˜¯å¦æ˜¯æ•°ç»„ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™ä½¿ç”¨ length ä½œä¸º key å»å»ºç«‹ç›¸åº”è”ç³»:

```js
function createReactive(obj, isShallow = false, isReadonly = false) {
	return new Proxy(obj, {
		// çœç•¥å…¶ä»–æ‹¦æˆªå‡½æ•°
		ownKeys(target) {
			// å¦‚æœæ“ä½œç›®æ ‡ target æ˜¯æ•°ç»„ï¼Œ åˆ™ä½¿ç”¨lengthå±æ€§ä½œä¸º key å¹¶å»ºç«‹ç›¸åº”è”ç³»
			track(target, Array.isArray(target) ? "length" : ITERATE_KEY)
			return Reflect.ownKeys(target)
		}
	})
}
```

è¿™æ ·æ— è®ºæ˜¯ä¸ºæ•°ç»„æ·»åŠ æ–°å…ƒç´ ï¼Œè¿˜æ˜¯ç›´æ¥ä¿®æ”¹ length å±æ€§ï¼Œéƒ½èƒ½å¤Ÿæ­£ç¡®åœ°è§¦å‘å“åº”äº†:

```js
const arr = reactive(["foo"])

effect(() => {
	for (const key in arr) {
		console.log(key)
	}
})

arr[1] = "bar" // èƒ½å¤Ÿè§¦å‘å‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œ
arr.length = 0 // èƒ½å¤Ÿè§¦å‘å‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œ
```

è®²è§£ä½¿ç”¨äº† for...in éå†æ•°ç»„ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å†çœ‹å‘çœ‹ä½¿ç”¨ for...of éå†æ•°ç»„çš„æƒ…å†µã€‚ä¸ for...in ä¸åŒï¼Œfor...of æ˜¯ç”¨æ¥éå†å¯è¿­ä»£å¯¹è±¡(iterable object)çš„ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å…ˆææ¸…æ¥šä»€ä¹ˆæ˜¯å¯è¿­ä»£å¯¹è±¡ã€‚ES2015 ä¸º JavaScript å®šä¹‰äº†**è¿­ä»£åè®®**ï¼ˆiteration protocolï¼‰,å®ƒä¸æ˜¯æ–°çš„è¯­æ³•ï¼Œè€Œæ˜¯ä¸€ç§åè®®ã€‚å…·ä½“æ¥è¯´ï¼Œä¸€ä¸ªå¯¹è±¡èƒ½å¦è¢«è¿­ä»£ï¼Œå–å†³äºè¯¥å¯¹è±¡æˆ–è€…è¯¥å¯¹è±¡çš„åŸå‹æ˜¯å¦å®ç°äº†@@iterator æ–¹æ³•ã€‚è¿™é‡Œçš„@@[name]æ ‡å¿—åœ¨ ECMAScript è§„èŒƒé‡Œç”¨æ¥ä»£æŒ‡ JavaScript å†…å»ºçš„ symbols å€¼ï¼Œä¾‹å¦‚ @@iterator æŒ‡çš„å°±æ˜¯ Symbol.iterator è¿™ä¸ªå€¼ã€‚å¦‚æœå¯¹è±¡å®ç°äº† Symbol.iterator æ–¹æ³•ï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡å°±æ˜¯å¯ä»¥è¿­ä»£çš„ï¼Œä¾‹å¦‚:

```js
const obj = {
	val: 0,
	[Symbol.iterator]() {
		return {
			next() {
				return {
					value: obj.val++,
					done: obj.val > 10 ? true : false
				}
			}
		}
	}
}
```

è¯¥å¯¹è±¡å®ç°äº† Symbol.iterator æ–¹æ³•ï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨ for...of å¾ªç¯éå†å®ƒ:

```js
for (const value of obj) {
	console.log(value) // 0 åˆ° 9
}
```

æ•°ç»„å†…å»ºäº† Symbol.iterator æ–¹æ³•çš„å®ç°ï¼Œæˆ‘ä»¬å¯ä»¥åšä¸€ä¸ªå®éªŒ:

```js
const arr = [1, 2, 3, 4, 5]
// è·å–å¹¶è°ƒç”¨æ•°ç»„å†…å»ºçš„è¿­ä»£å™¨æ–¹æ³•
const itr = arr[Symbol.iterator]()

console.log(itr.next()) // {value: 1, done: false}
console.log(itr.next()) // {value: 2, done: false}
console.log(itr.next()) // {value: 3, done: false}
console.log(itr.next()) // {value: 4, done: false}
console.log(itr.next()) // {value: 5, done: false}
console.log(itr.next()) // {value: undefined, done: false}
```

å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬èƒ½å¤Ÿé€šè¿‡å°† Symbol.iterator ä½œä¸ºé”®ï¼Œè·å–æ•°ç»„å†…å»ºçš„è¿­ä»£å™¨æ–¹æ³•ã€‚ç„¶åæ‰‹åŠ¨æ‰§è¡Œè¿­ä»£å™¨çš„ next å‡½æ•°ï¼Œè¿™æ ·ä¹Ÿå¯ä»¥å¾—åˆ°æœŸæœ›çš„ç»“æœã€‚è¿™ä¹Ÿæ˜¯é»˜è®¤æƒ…å†µä¸‹æ•°ç»„å¯ä»¥ä½¿ç”¨ for...of éå†çš„åŸå› :

```js
const arr = [1, 2, 3, 4, 5]

for (const val of arr) {
	console.log(val) // 1, 2, 3, 4, 5
}
```

å®é™…ä¸Šï¼Œæƒ³è¦å®ç°å¯¹æ•°ç»„è¿›è¡Œ for...of éå†æ“ä½œçš„æ‹¦æˆªï¼Œå…³é”®ç‚¹åœ¨äºæ‰¾åˆ° for...of æ“ä½œä¾èµ–çš„åŸºæœ¬è¯­ä¹‰ã€‚åœ¨è§„èŒƒçš„ 23.1.5.1 èŠ‚ä¸­å®šä¹‰äº†æ•°ç»„è¿­ä»£å™¨çš„æ‰§è¡Œæµç¨‹ï¼Œå¦‚æœæ‰€ç¤ºã€‚

![img](../assets/VueImage/EMCA-262-forOf.png)

å›¾ä¸­ç¬¬ 1 æ­¥çš„ b å­æ­¥éª¤æ‰€æè¿°å†…å®¹å¦‚ä¸‹ã€‚

b. é‡å¤ä»¥ä¸‹æ­¥éª¤

i. å¦‚æœ array æœ‰ [[TypedArrayName]]å†…éƒ¨æ§½ï¼Œé‚£ä¹ˆ

    	1. å¦‚æœ IsDetachedBuffer(array.[[ViewedArrayBuffer]])æ˜¯trueï¼Œåˆ™æŠ›å‡ºTypeError å¼‚å¸¸ã€‚
    	2. è®© len çš„å€¼ä¸º array.[[ArrayLength]]

ii. å¦åˆ™

    	1. è®© len çš„å€¼ä¸º LengthOfArrayLike(array)

iii. å¦‚æœ index > len, åˆ™è¿”å› undefined

iv. å¦‚æœ kind æ˜¯ keyï¼Œ åˆ™æ‰§è¡Œ ? GeneratorYield(CreateIterResultObject(F(index),false))

v. å¦åˆ™

    	1. è®© elementKeyçš„å€¼ä¸º !ToString(ğ”½(index))
    	2. è®© elementValue çš„å€¼ä¸º ?Get(array,elementKey)
    	3. å¦‚æœ kind æ˜¯ valueï¼Œ æ‰§è¡Œ ? GeneratorYield(CreateIterResultObject(elementValue,false))
    	4. å¦åˆ™
    		a. æ–­è¨€: kind æ˜¯ key + value
    		b. è®© result æ˜¯ ? CreateArrayFromList(Â« ğ”½(index), elementValue Â»)
    		c. æ‰§è¡Œ ? GeneratorYield(CreateIterResultObject(elementValue, false))

vi. å°† index è®¾ç½®ä¸º index + 1

å¯ä»¥çœ‹åˆ°ï¼Œæ•°ç»„è¿­ä»£å™¨çš„æ‰§è¡Œä¼šè¯»å–æ•°ç»„çš„ length å±æ€§ã€‚å¦‚æœè¿­ä»£çš„æ˜¯æ•°ç»„çš„å…ƒç´ å€¼ï¼Œè¿˜ä¼šè¯»å–æ•°ç»„çš„ç´¢å¼•ã€‚å…¶å®æˆ‘ä»¬å¯ä»¥ç»™å‡ºä¸€ä¸ªæ•°ç»„è¿­ä»£å™¨çš„æ¨¡æ‹Ÿå®ç°:

```js
const arr = [1, 2, 3, 4, 5]

arr[Symbol.iterator] = function () {
	const target = this
	const len = target.length
	let index = 0

	return {
		next() {
			return {
				value: index < len ? target[index] : undefined,
				done: index++ >= len
			}
		}
	}
}
```

å¦‚ä¸Šé¢çš„ä»£ç æ‰€ç¤ºï¼Œæˆ‘ä»¬ç”¨è‡ªå®šä¹‰çš„å®ç°è¦†ç›–äº†æ•°ç»„å†…å»ºçš„è¿­ä»£å™¨æ–¹æ³•ï¼Œä½†å®ƒä»ç„¶èƒ½å¤Ÿæ­£å¸¸å·¥ä½œã€‚

è¿™ä¸ªä¾‹å­è¡¨æ˜ï¼Œè¿­ä»£æ•°ç»„æ—¶ï¼Œ åªéœ€è¦åœ¨å‰¯ä½œç”¨å‡½æ•°ä¸æ•°ç»„çš„é•¿åº¦å’Œç´¢å¼•ä¹‹é—´å»ºç«‹å“åº”è”ç³»ï¼Œå°±èƒ½å¤Ÿå®ç°å“åº”å¼çš„ for...of è¿­ä»£:

```js
const arr = reactive([1, 2, 3, 4, 5])

effect(() => {
	for (const val of arr) {
		console.log(val)
	}
})

arr[1] = "bar" // èƒ½å¤Ÿè§¦å‘å“åº”
arr.length = 0 // èƒ½å¤Ÿè§¦å‘å“åº”
```

å¯ä»¥çœ‹åˆ°ï¼Œä¸éœ€è¦å¢åŠ ä»»ä½•ä»£ç å°±èƒ½å¤Ÿä½¿å…¶æ­£ç¡®åœ°å·¥ä½œã€‚è¿™æ˜¯å› ä¸ºåªè¦æ•°ç»„çš„é•¿åº¦å’Œå…ƒç´ å€¼å‘ç”Ÿç™¾å˜ï¼Œå‰¯ä½œç”¨å‡½æ•°è‡ªç„¶ä¼šé‡æ–°æ‰§è¡Œã€‚

è¿™é‡Œä¸å¾—ä¸æçš„ä¸€ç‚¹ï¼Œæ•°ç»„çš„ values æ–¹æ³•çš„è¿”å›å€¼å®é™…ä¸Šå°±æ˜¯æ•°ç»„å†…å»ºçš„è¿­ä»£å™¨ï¼Œæˆ‘ä»¬å¯ä»¥éªŒè¯è¿™ä¸€ç‚¹:

```js
console.log(Array.prototype.values === Array.prototype[Symbol.iterator]) // true
```

æ¢å¥è¯è¯´ï¼Œåœ¨ä¸å¢åŠ ä»»ä½•ä»£ç çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¹Ÿèƒ½å¤Ÿè®©æ•°ç»„çš„è¿­ä»£å™¨æ–¹æ³•æ­£ç¡®çš„å·¥ä½œ:

```js
const arr = reactive([1, 2, 3, 4, 5])

effect(() => {
	for (const val of arr.values()) {
		console.log(val)
	}
})

arr[1] = "bar" // èƒ½å¤Ÿè§¦å‘å“åº”
arr.length = 0 // èƒ½å¤Ÿè§¦å‘å“åº”
```

æœ€åéœ€è¦æŒ‡å‡ºçš„æ˜¯ï¼Œæ— è®ºæ˜¯ä½¿ç”¨ for...of å¾ªç¯ï¼Œè¿˜æ˜¯è°ƒç”¨ values ç­‰æ–¹æ³•ï¼Œå®ƒä»¬éƒ½ä¼šè¯»å–æ•°ç»„çš„ Symbol.iterator å±æ€§ã€‚è¯¥å±æ€§æ˜¯ä¸€ä¸ª symbol å€¼ï¼Œä¸ºäº†é¿å…å‘ç”Ÿæ„å¤–çš„é”™è¯¯ï¼Œä»¥åŠæ€§èƒ½ä¸Šçš„è€ƒè™‘ï¼Œæˆ‘ä»¬ä¸åº”è¯¥åœ¨å‰¯ä½œç”¨å‡½æ•°ä¸ Symbol.iterator è¿™ç±»çš„ symbol å€¼ä¹‹é—´å»ºç«‹å“åº”è”ç³»ï¼Œå› æ­¤éœ€è¦ä¿®æ”¹ get æ‹¦æˆªå‡½æ•°ï¼Œå¦‚ä»¥ä¸‹ä»£ç æ‰€ç¤º:

```js
function createReactive(obj, isShallow = false, isReadonly = false) {
	return new Proxy(obj, {
		// æ‹¦æˆªè¯»å–æ“ä½œ
		get(target, key, receiver) {
			console.log("get: ", key)

			if (key === "raw") {
				return target
			}

			// æ·»åŠ åˆ¤æ–­ï¼Œ å¦‚æœ key çš„ç±»å‹æ˜¯ symbol,åˆ™ä¸è¿›è¡Œè¿½è¸ª
			if(!isReadonly && typeof !== 'symbol') {
				track(target,key)
			}

			const res = Reflect.get(target,key,receiver)

			if(isShallow) {
				return res
			}

			if(typeof res === 'object' && res !== null) {
				return isReadonly ? readonly(res): reactive(res)
			}

			return res
		}
	})
}
```

åœ¨è°ƒç”¨ track å‡½æ•°è¿›è¡Œè¿½è¸ªä¹‹å‰ï¼Œ éœ€è¦æ·»åŠ ä¸€ä¸ªåˆ¤æ–­æ¡ä»¶ï¼Œå³åªæœ‰å½“ key çš„ç±»å‹ä¸æ˜¯ symbol æ—¶æ‰è¿›è¡Œè¿½è¸ªï¼Œè¿™æ ·å°±é¿å…äº†ä¸Šè¿°é—®é¢˜ã€‚

## æ•°ç»„çš„æŸ¥æ‰¾æ–¹æ³•

é€šè¿‡ä¸Šä¸€èŠ‚çš„ä»‹ç»æˆ‘ä»¬æ„è¯†åˆ°ï¼Œæ•°ç»„çš„æ–¹æ³•å†…éƒ¨å…¶å®éƒ½ä¾èµ–äº†å¯¹è±¡çš„åŸºæœ¬è¯­ä¹‰ã€‚æ‰€ä»¥å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸éœ€è¦åšç‰¹æ®Šå¤„ç†å³å¯è®©è¿™äº›æ–¹æ³•æŒ‰é¢„æœŸå·¥ä½œï¼Œä¾‹å¦‚:

```js
const arr = reactive([1, 2])

effect(() => {
	console.log(arr.includes(1)) // åˆå§‹æ‰“å° true
})

arr[0] = 3 // å‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œï¼Œå¹¶æ‰“å° false
```

è¿™æ˜¯å› ä¸º includes æ–¹æ³•ä¸ºäº†æ‰¾åˆ°ç»™å®šçš„å€¼ï¼Œå®ƒå†…éƒ¨ä¼šè®¿é—®æ•°ç»„çš„ length å±æ€§ä»¥åŠæ•°ç»„çš„ç´¢å¼•ï¼Œå› æ­¤å½“æˆ‘ä»¬ä¿®æ”¹äº†æŸä¸ªç´¢å¼•æŒ‡å‘çš„å…ƒç´ å€¼åèƒ½å¤Ÿè§¦å‘å“åº”ã€‚

ç„¶è€Œ includes æ–¹æ³•å¹¶ä¸æ€»æ˜¯æŒ‰ç…§é¢„æœŸå·¥ä½œï¼Œä¸¾ä¸ªä¾‹å­:

```js
const obj = {}
const arr = reactive([obj])

console.log(arr.includes(arr[0])) // false
```

å¦‚ä¸Šé¢çš„ä»£ç æ‰€ç¤ºã€‚ æˆ‘ä»¬é¦–å…ˆå®šä¹‰ä¸€ä¸ª objï¼Œå¹¶å°†å…¶ä½œä¸ºæ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œç„¶åè°ƒç”¨ reactive å‡½æ•°ä¸ºå…¶åˆ›å»ºä¸€ä¸ªå“åº”å¼å¯¹è±¡ï¼Œæ¥ç€å°è¯•è°ƒç”¨ includes æ–¹æ³•åœ¨æ•°ç»„ä¸­è¿›è¡ŒæŸ¥æ‰¾ï¼Œçœ‹çœ‹å…¶ä¸­æ˜¯å¦åŒ…å«ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚å¾ˆæ˜¾ç„¶ï¼Œè¿™ä¸ªæ“ä½œåº”è¯¥è¿”å› true,ä½†å¦‚æœä½ å°è¯•è¿è¡Œè¿™æ®µä»£ç ï¼Œä¼šå‘ç°å®ƒè¿”å›äº† falseã€‚

ä¸ºä»€ä¹ˆä¼šè¿™æ ·å‘¢ï¼Ÿ è¿™éœ€è¦æˆ‘ä»¬å»æŸ¥é˜…è¯­è¨€è§„èŒƒï¼Œçœ‹çœ‹ includes æ–¹æ³•çš„æ‰§è¡Œæµç¨‹æ˜¯æ€æ ·çš„ã€‚è§„èŒƒçš„ 23.1.3.16 èŠ‚ç»™å‡ºäº† includes æ–¹æ³•çš„æ‰§è¡Œæµç¨‹ï¼Œå¦‚å›¾æ‰€ç¤ºã€‚

![img](../assets/VueImage/ECMA-262-includes.png)

å›¾ä¸­å±•ç¤ºäº† includes æ–¹æ³•çš„æ‰§è¡Œæµç¨‹ï¼Œæˆ‘ä»¬é‡ç‚¹å…³æ³¨ç¬¬ 1 æ­¥å’Œç¬¬ 10 æ­¥ã€‚å…¶ä¸­ç¬¬ 1 æ­¥æ‰€æè¿°çš„å†…å®¹å¦‚ä¸‹ã€‚

1. è®© O çš„å€¼ä¸º ?ToObject(this value)
2. é‡å¤, while å¾ªç¯(æ¡ä»¶ K< len),

   a. è®© elementK çš„å€¼ä¸º ? Get(O, !ToString(ğ”½(k)))çš„ç»“æœã€‚

   b. å¦‚æœ SameValueZero(searchElement, elementK) æ˜¯ trueï¼Œ åˆ™è¿”å› trueã€‚

   c. å°† K è¿™æ˜¯ä¸º K + 1

è¿™é‡Œæ³¨æ„ç¬¬ 1 æ­¥ï¼Œè®© O çš„å€¼ä¸º ?ToObject(this value),è¿™é‡Œçš„ this æ˜¯è°å‘¢ï¼Ÿ åœ¨ arr.includes(arr[0])è¯­å¥ä¸­ï¼Œarr æ˜¯ä»£ç†å¯¹è±¡ï¼Œæ‰€ä»¥ includes å‡½æ•°æ‰§è¡Œæ—¶çš„ this æŒ‡å‘çš„æ˜¯ä»£ç†å¯¹è±¡ï¼Œå³ arrã€‚æ¥ç€æˆ‘ä»¬çœ‹ç¬¬ 10.a æ­¥ï¼Œå¯ä»¥çœ‹åˆ° includes æ–¹æ³•ä¼šé€šè¿‡ç´¢å¼•è¯»å–æ•°ç»„å…ƒç´ çš„å€¼ï¼Œä½†è¿™æ˜¯è¿™é‡Œçš„ O æ˜¯ä»£ç†å¯¹è±¡ arrã€‚æˆ‘ä»¬çŸ¥é“ï¼Œé€šè¿‡ä»£ç†å¯¹è±¡æ¥è®¿é—®å…ƒç´ å€¼æ—¶ï¼Œå¦‚æœå€¼ä»ç„¶æ˜¯å¯ä»¥è¢«ä»£ç†ï¼Œé‚£ä¹ˆå¾—åˆ°çš„å°±æ˜¯ä¸€ä¸ªæ–°çš„ä»£ç†å¯¹è±¡è€ŒéåŸå§‹å¯¹è±¡ã€‚ä¸‹é¢è¿™æ®µ get æ‹¦æˆªå‡½æ•°å†…çš„ä»£ç å¯ä»¥è¯æ˜è¿™ä¸€ç‚¹:

```js
if (typeof res === "object" && res !== null) {
	// å¦‚æœå¯ä»¥è¢«ä»£ç†ï¼Œ åˆ™è¿”å›ä»£ç†å¯¹è±¡
	return isReadonly ? readonly(res) : reactive(res)
}
```

çŸ¥é“è¿™äº›åï¼Œæˆ‘ä»¬å†å›å¤´çœ‹è¿™å¥ä»£ç : arr.includes(arr[0])ã€‚å…¶ä¸­,arr[0]å¾—åˆ°çš„æ˜¯ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œè€Œåœ¨ includes æ–¹æ³•å†…éƒ¨ä¹Ÿä¼šé€šè¿‡ arr è®¿é—®æ•°ç»„å…ƒç´ ï¼Œä»è€Œä¹Ÿå¾—åˆ°ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œé—®é¢˜æ˜¯ä¸¤ä¸ªä»£ç†å¯¹è±¡æ˜¯ä¸åŒçš„ã€‚è¿™æ˜¯å› ä¸ºæ¯æ¬¡è°ƒç”¨ reactive å‡½æ•°æ—¶éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ä»£ç†å¯¹è±¡:

```js
function reactive(obj) {
	// æ¯æ¬¡è°ƒç”¨ reactive æ—¶ï¼Œ éƒ½ä¼šåˆ›å»ºæ–°çš„ä»£ç†å¯¹è±¡
	return createReactive(obj)
}
```

å³ä½¿å‚æ•° obj æ˜¯ç›¸åŒçš„ï¼Œæ¯æ¬¡è°ƒç”¨ reactive å‡½æ•°æ—¶ï¼Œä¹Ÿéƒ½ä¼šåˆ›å»ºæ–°çš„ä»£ç†å¯¹è±¡ã€‚è¿™ä¸ªé—®é¢˜çš„è§£å†³æ–¹æ¡ˆå¦‚ä¸‹æ‰€ç¤º:

```js
// å®šä¹‰ä¸€ä¸ª Map å®ä¾‹ï¼Œ å­˜å‚¨åŸå§‹å¯¹è±¡åˆ°ä»£ç†å¯¹è±¡çš„æ˜ å°„
const reactiveMap = new Map()

function reactive(obj) {
	// ä¼˜å…ˆé€šè¿‡åŸå§‹å¯¹è±¡ obj å¯»æ‰¾ä¹‹å‰åˆ›å»ºçš„ä»£ç†å¯¹è±¡ï¼Œå¦‚æœæ‰¾åˆ°äº†ï¼Œç›´æ¥è¿”å›å·²æœ‰çš„ä»£ç†å¯¹è±¡
	const existProxy = reactiveMap.get(obj)
	if (exitProxy) return existProxy

	// å¦åˆ™ï¼Œåˆ›å»ºæ–°çš„ä»£ç†å¯¹è±¡
	const proxy = createReactive(obj)

	// å­˜å‚¨åˆ° Map ä¸­ï¼Œä»è€Œé¿å…é‡å¤åˆ›å»º
	reactiveMap.set(obj, proxy)

	return proxy
}
```

åœ¨ä¸Šé¢è¿™æ®µä»£ç ä¸­ï¼Œ æˆ‘ä»¬å®šä¹‰äº† reactiveMapï¼Œç”¨æ¥å­˜å‚¨åŸå§‹å¯¹è±¡åˆ°ä»£ç†å¯¹è±¡çš„æ˜ å°„ã€‚æ¯æ¬¡è°ƒç”¨ reactive å‡½æ•°åˆ›å»ºä»£ç†å¯¹è±¡ä¹‹å‰ï¼Œä¼˜å…ˆæ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨ç›¸åº”çš„ä»£ç†å¯¹è±¡ï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ™ç›´æ¥è¿”å›å·²æœ‰çš„ä»£ç†å¯¹è±¡ï¼Œè¿™æ ·å°±é¿å…äº†ä¸ºåŒä¸€ä¸ªåŸå§‹å¯¹è±¡å¤šæ¬¡åˆ›å»ºä»£ç†å¯¹è±¡çš„é—®é¢˜ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å†æ¬¡è¿è¡Œæœ¬èŠ‚å¼€å¤´çš„ä¾‹å­:

```js
const obj = {}
const arr = reactive([obj])

console.log(arr.includes(arr[0])) // true
```

å¯ä»¥å‘ç°ï¼Œæ­¤æ—¶çš„è¡Œä¸ºå·²ç»ç¬¦åˆé¢„æœŸäº†ã€‚
ç„¶è€Œï¼Œè¿˜ä¸èƒ½é«˜å…´å¾—å¤ªæ—©ï¼Œå†æ¥çœ‹ä¸‹é¢çš„ä»£ç :

```js
const obj = {}
const arr = reactive([obj])

console.log(arr.includes(obj)) // false
```

åœ¨ä¸Šé¢è¿™æ®µä»£ç ä¸­ï¼Œ æˆ‘ä»¬ç›´æ¥æŠŠåŸå§‹å¯¹è±¡ä½œä¸ºå‚æ•°ä¼ é€’ç»™ includes æ–¹æ³•ï¼Œè¿™æ˜¯å¾ˆç¬¦åˆç›´è§‰çš„è¡Œä¸ºã€‚è€Œä»ç”¨æˆ·çš„è§’åº¦æ¥çœ‹ï¼Œè‡ªå·±æ˜æ˜æŠŠ obj ä½œä¸ºæ•°ç»„çš„ä¸€ä¸ªå…ƒç´ äº†ï¼Œä¸ºä»€ä¹ˆåœ¨æ•°ç»„ä¸­å´ä»ç„¶æ‰¾ä¸åˆ° obj å¯¹è±¡å‘¢ï¼Ÿå…¶å®åŸå› å¾ˆç®€å•ï¼Œå› ä¸º includes å†…éƒ¨çš„ this æŒ‡å‘çš„æ˜¯ä»£ç†å¯¹è±¡ arrï¼Œå¹¶ä¸”åœ¨è·å–å…ƒç´ æ—¶å¾—åˆ°çš„å€¼ä¹Ÿæ˜¯ä»£ç†å¯¹è±¡ï¼Œæ‰€ä»¥æ‹¿åŸå§‹å¯¹è±¡ obj å»æŸ¥æ‰¾è‚¯å®šæ‰¾ä¸åˆ°ï¼Œå› æ­¤è¿”å› falseã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦é‡å†™æ•°ç»„çš„ includes æ–¹æ³•å¹¶å®ç°è‡ªå®šä¹‰çš„è¡Œä¸ºï¼Œæ‰èƒ½è§£å†³è¿™ä¸ªé—®é¢˜ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•é‡å†™ includes æ–¹æ³•ï¼Œå¦‚ä¸‹é¢çš„ä»£ç æ‰€ç¤º:

```js
const arrayInstrumentations = {
	includes: function () {
		/* ... */
	}
}

function createReactiveObj(obj, isShallow = false, isReadonly = false) {
	return new Proxy(obj, {
		// æ‹¦æˆªè¯»å–æ“ä½œ
		get(target, key, receiver) {
			console.log("get:", key)
			if (key === "raw") {
				return target
			}

			// å¦‚æœæ“ä½œçš„ç›®æ ‡å¯¹è±¡æ˜¯æ•°ç»„ï¼Œå¹¶ä¸” key å­˜åœ¨äº arrayInstrumentations ä¸Šï¼Œ
			// é‚£ä¹ˆè¿”å›å®šä¹‰åœ¨ arrayInstrumentations ä¸Šçš„å€¼
			if (Array.isArray(target) && arrayInstrumentations.hasOwnProperty(key)) {
				return Reflect.get(arrayInstrumentations, key, receiver)
			}

			if (!isReadonly && typeof key !== "symbol") {
				track(target, key)
			}

			const res = Reflect.get(target, key, receiver)

			if (isShallow) {
				return res
			}

			if (typeof res === "obj" && res !== null) {
				return isReadonly ? readonly(res) : reactive(res)
			}

			return res
		}
	})
}
```

åœ¨ä¸Šé¢è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬ä¿®æ”¹äº† get æ‹¦æˆªå‡½æ•°ï¼Œç›®çš„æ˜¯é‡å†™æ•°ç»„çš„ includes æ–¹æ³•ã€‚å…·ä½“æ€ä¹ˆåšå‘¢ï¼Ÿ æˆ‘ä»¬çŸ¥é“ï¼Œarr.includes å¯ä»¥ç†è§£ä¸ºè¯»å–ä»£ç†å¯¹è±¡ arr çš„ includes å±æ€§ï¼Œè¿™å°±ä¼šè§¦å‘ get æ‹¦æˆªå‡½æ•°ï¼Œåœ¨è¯¥å‡½æ•°å†…æ£€æŸ¥ target æ˜¯å¦æ˜¯æ•°ç»„ï¼Œå¦‚æœæ˜¯æ•°ç»„å¹¶ä¸”è¯»å–çš„é”®å€¼å­˜åœ¨äº arrayInstrumentations ä¸Šï¼Œåˆ™è¿”å›å®šä¹‰åœ¨ arrayInstrumentations å¯¹è±¡ä¸Šç›¸åº”çš„å€¼ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“æ‰§è¡Œ arr.includes æ—¶ï¼Œå®é™…æ‰§è¡Œçš„æ˜¯å®šä¹‰åœ¨ arrayInstrumentations ä¸Šçš„ includes å‡½æ•°ï¼Œè¿™æ ·å°±å®ç°äº†é‡å†™ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥è‡ªå®šä¹‰ includes å‡½æ•°äº†:

```js
const originMethod = Array.prototype.includes

const arrayInstrumentations = {
	includes: function (...args) {
		// this æ˜¯ä»£ç†å¯¹è±¡ï¼Œ å…ˆåœ¨ä»£ç†å¯¹è±¡ä¸­æŸ¥æ‰¾ï¼Œå°†ç»“æœå­˜å‚¨åˆ° res ä¸­
		let res = originMethod.apply(this, args)

		if (res === false) {
			// res ä¸º false è¯´æ˜æ²¡æ‰¾åˆ°ï¼Œ é€šè¿‡ this.raw é‚£åˆ°åŸå§‹æ•°ç»„ï¼Œ å†å»å…¶ä¸­æŸ¥æ‰¾å¹¶æ›´æ–°å€¼
			res = originMethod.apply(this.raw, args)
		}

		// è¿”å›æœ€ç»ˆç»“æœ
		return res
	}
}
```

å¦‚ä¸Šé¢è¿™æ®µä»£ç æ‰€ç¤ºï¼Œ å…¶ä¸­ includes æ–¹æ³•å†…çš„ this æŒ‡å‘çš„æ˜¯ä»£ç†å¯¹è±¡ï¼Œ æˆ‘ä»¬å…ˆåœ¨ä»£ç†å¯¹è±¡ä¸­è¿›è¡ŒæŸ¥æ‰¾ï¼Œè¿™å…¶å®æ˜¯å®ç°äº† arr.include(obj)çš„é»˜è®¤è¡Œä¸ºã€‚å¦‚æœæ‰¾ä¸åˆ°ï¼Œé€šè¿‡ this.raw é‚£åˆ°åŸå§‹æ•°ç»„,å†å»å…¶ä¸­æŸ¥æ‰¾ï¼Œæœ€åè¿”å›ç»“æœï¼Œè¿™æ ·å°±è§£å†³äº†ä¸Šè¿°é—®é¢˜ã€‚è¿è¡Œå¦‚ä¸‹æµ‹è¯•ä»£ç :

```js
const obj = {}
const arr = reactive([obj])

console.log(arr.includes(obj)) // true
```

å¯ä»¥å‘ç°ï¼Œç°åœ¨ä»£ç çš„è¡Œä¸ºå·²ç»ç¬¦åˆé¢„æœŸäº†ã€‚

é™¤äº† includes æ–¹æ³•ä¹‹å¤–ï¼Œ è¿˜éœ€è¦åšç±»ä¼¼å¤„ç†çš„æ•°ç»„æ–¹æ³•æœ‰ indexOf å’Œ lastIndexOfï¼Œå› ä¸ºå®ƒä»¬éƒ½å±äºæ ¹æ®ç»™å®šçš„å€¼è¿”å›æŸ¥æ‰¾ç»“æœçš„æ–¹æ³•ã€‚å®Œæ•´çš„ä»£ç å¦‚ä¸‹:

```js
const arrayInstrumentations = {}

;["includes", "indexOf", "lastIndexOf"].forEach((method) => {
	const originMethod = Array.prototype[method]
	arrayInstrumentations[method] = function (...args) {
		// this æ˜¯ä»£ç†å¯¹è±¡ï¼Œ å…ˆåœ¨ä»£ç†å¯¹è±¡ä¸­æŸ¥æ‰¾ï¼Œå°†ç»“æœå­˜å‚¨åˆ° res ä¸­
		let res = originMethod.apply(this, args)

		if (res === false || res === -1) {
			// res ä¸º false è¯´æ˜æ²¡æ‰¾åˆ°ï¼Œ é€šè¿‡ this.raw é‚£åˆ°åŸå§‹æ•°ç»„ï¼Œ å†å»å…¶ä¸­æŸ¥æ‰¾å¹¶æ›´æ–° res å€¼
			res = originMethod.apply(this.raw, args)
		}
		// è¿”å›æœ€ç»ˆç»“æœ
		return res
	}
})
```

## éšå¼ä¿®æ”¹æ•°ç»„é•¿åº¦çš„åŸå‹æ–¹æ³•

æœ¬èŠ‚ä¸­æˆ‘ä»¬è®²è§£å¦‚ä½•å¤„ç†é‚£äº›ä¼šéšå¼ä¿®æ”¹æ•°ç»„é•¿åº¦çš„æ–¹æ³•ï¼Œä¸»è¦æŒ‡çš„æ˜¯æ•°ç»„çš„æ ˆæ–¹æ³•ï¼Œ ä¾‹å¦‚ push/pop/shift/unshiftã€‚é™¤æ­¤ä¹‹å¤–ï¼Œsplice æ–¹æ³•ä¹Ÿä¼šéšå¼åœ°çš„ä¿®æ”¹æ•°ç»„é•¿åº¦ï¼Œæˆ‘ä»¬å¯ä»¥æŸ¥é˜…è§„èŒƒæ¥è¯å®è¿™ä¸€ç‚¹ã€‚ä»¥ push æ–¹æ³•ä¸ºä¾‹ï¼Œè§„èŒƒçš„ 23.1.3.23 èŠ‚å®šä¹‰äº† push æ–¹æ³•çš„æ‰§è¡Œæµç¨‹ï¼Œå¦‚å›¾æ‰€ç¤ºã€‚

![img](../assets/VueImage/ECMA-262-push.png)

å½“è°ƒç”¨ push æ–¹æ³•å¹¶ä¼ é€’ 0 ä¸ªæˆ–å¤šä¸ªå‚æ•°æ—¶ï¼Œä¼šæ‰§è¡Œä¸€ä¸‹æ­¥éª¤ã€‚

1. è®© O çš„å€¼ä¸º ? ToObject(this value)
2. è®© len çš„å€¼ä¸º ? LengthOfArrayLike(O)
3. è®© argCount çš„å€¼ä¸º items çš„å…ƒç´ æ•°é‡
4. å¦‚æœ len + argCount > $2^{53}$ - 1, åˆ™æŠ›å‡º TypeError å¼‚å¸¸
5. å¯¹äº items ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´  E:

   a. æ‰§è¡Œ ï¼ŸSet(O, !ToString(ğ”½(len)), E, true)

   b. å°† len è¿™æ˜¯ä¸º len + 1

6. æ‰§è¡Œ ï¼ŸSet(O, "length", ğ”½(len),true)
7. è¿”å› ğ”½(len)

ç”±ç¬¬ 2 æ­¥å’Œç¬¬ 6 æ­¥å¯çŸ¥ï¼Œå½“è°ƒç”¨æ•°ç»„çš„ push æ–¹æ³•æƒ³æ•°ç»„æ·»åŠ å…ƒç´ æ—¶ï¼Œæ—¢ä¼šè¯»å–æ•°ç»„çš„ length å±æ€§å€¼ï¼Œä¹Ÿä¼šè®¾ç½®æ•°ç»„çš„ length å±æ€§å€¼ã€‚åˆ™ä¼šå¯¼è‡´ä¸¤ä¸ªç‹¬ç«‹çš„å‰¯ä½œç”¨å‡½æ•°äº’ç›¸å½±å“ã€‚ä»¥ä¸‹é¢ä»£ç ä¸ºä¾‹:

```js
const arr = reactive([])

// ç¬¬ä¸€ä¸ªå‰¯ä½œç”¨å‡½æ•°
effect(() => {
	arr.push(1)
})

// ç¬¬äºŒä¸ªå‰¯ä½œç”¨å‡½æ•°
effect(() => {
	arr.push(1)
})
```

å¦‚æœä½ å°è¯•åœ¨æµè§ˆå™¨ä¸­è¿è¡Œä¸Šé¢è¿™æ®µä»£ç ï¼Œä¼šå¾—åˆ°æ ˆæº¢å‡ºçš„é”™è¯¯(Maximum call stack size exceeded)ã€‚

ä¸ºä»€ä¹ˆä¼šè¿™æ ·å‘¢ï¼Ÿ æˆ‘ä»¬æ¥è¯¦ç»†åˆ†æä¸Šé¢è¿™æ®µä»£ç çš„æ‰§è¡Œè¿‡ç¨‹ã€‚

- ç¬¬ä¸€ä¸ªå‰¯ä½œç”¨å‡½æ•°æ‰§è¡Œã€‚åœ¨è¯¥å‡½æ•°å†…ï¼Œè°ƒç”¨ arr.push æ–¹æ³•å‘æ•°ç»„æ·»åŠ äº†ä¸€ä¸ªå…ƒç´ ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œè°ƒç”¨æ•°ç»„çš„ push æ–¹æ³•ä¼šé—´æ¥çš„è¯»å–æ•°ç»„çš„ length å±æ€§ã€‚æ‰€ä»¥ï¼Œå½“ç¬¬ä¸€ä¸ªå‰¯ä½œç”¨å‡½æ•°æ‰§è¡Œå®Œæ¯•åï¼Œä¼šä¸ length å±æ€§å»ºç«‹å“åº”è”ç³»ã€‚
- æ¥ç€ï¼Œç¬¬äºŒä¸ªå‰¯ä½œç”¨å‡½æ•°æ‰§è¡Œã€‚ åŒæ ·ï¼Œ å®ƒä¹Ÿä¼šä¸ length å±æ€§å»ºç«‹å“åº”è”ç³»ã€‚ä½†ä¸è¦å¿˜è®°ï¼Œè°ƒç”¨ arr.push æ–¹æ³•ä¸ä»…ä¼šé—´æ¥è¯»å–æ•°ç»„çš„ length å±æ€§ï¼Œè¿˜ä¼šé—´æ¥è®¾ç½® length çš„å±æ€§çš„å€¼ã€‚
- ç¬¬äºŒä¸ªå‡½æ•°å†…çš„ arr.push æ–¹æ³•çš„è°ƒç”¨è®¾ç½®äº†æ•°ç»„çš„ length å±æ€§å€¼ã€‚äºæ˜¯ï¼Œå“åº”ç³»ç»Ÿå°è¯•æŠŠä¸ length å±æ€§ç›¸å…³è”çš„å‰¯ä½œç”¨å‡½æ•°å…¨éƒ¨å–å‡ºå¹¶æ‰§è¡Œï¼Œå…¶ä¸­å°±åŒ…æ‹¬ç¬¬ä¸€ä¸ªå‰¯ä½œç”¨å‡½æ•°ã€‚é—®é¢˜å°±å‡ºç°åœ¨è¿™é‡Œï¼Œå¯ä»¥å‘ç°ï¼Œç¬¬äºŒä¸ªå‰¯ä½œç”¨å‡½æ•°è¿˜æœªæ‰§è¡Œå®Œæ¯•ï¼Œå°±è¦å†æ¬¡æ‰§è¡Œç¬¬ä¸€ä¸ªå‰¯ä½œç”¨å‡½æ•°äº†ã€‚
- ç¬¬ä¸€ä¸ªå‰¯ä½œç”¨å‡½æ•°å†æ¬¡æ‰§è¡Œã€‚åŒæ ·ï¼Œè¿™ä¼šé—´æ¥è®¾ç½®æ•°ç»„çš„ length å±æ€§ã€‚äºæ˜¯ï¼Œå“åº”ç³»ç»Ÿåˆè¦å°è¯•æŠŠæ‰€æœ‰ä¸ length å±æ€§ç›¸å…³è”çš„å‰¯ä½œç”¨å‡½æ•°å–å‡ºå¹¶æ‰§è¡Œï¼Œå…¶ä¸­å°±åŒ…å«ç¬¬äºŒä¸ªå‰¯ä½œç”¨å‡½æ•°ã€‚
- å¦‚æ­¤å¾ªç¯å¾€å¤ï¼Œæœ€ç»ˆå¯¼è‡´è°ƒç”¨æ ˆæº¢å‡ºã€‚

é—®é¢˜çš„åŸå› æ˜¯ push æ–¹æ³•çš„è°ƒç”¨ä¼šé—´æ¥è¯»å– length å±æ€§ã€‚æ‰€ä»¥ï¼Œåªè¦æˆ‘ä»¬â€œå±è”½â€å¯¹ length å±æ€§çš„è¯»å–ï¼Œä»è€Œé¿å…åœ¨å®ƒä¸å‰¯ä½œç”¨å‡½æ•°ä¹‹é—´å»ºç«‹å“åº”è”ç³»ï¼Œé—®é¢˜å°±è¿åˆƒè€Œè§£äº†ã€‚è¿™ä¸ªæ€è·¯æ˜¯æ­£ç¡®çš„ï¼Œå› ä¸ºæ•°ç»„çš„ push æ–¹æ³•åœ¨è¯­ä¹‰ä¸Šæ˜¯ä¿®æ”¹æ“ä½œï¼Œè€Œéè¯»å–æ“ä½œï¼Œæ‰€ä»¥é¿å…å»ºç«‹å“åº”è”ç³»ä¸ä¼šäº§ç”Ÿå…¶ä»–å‰¯ä½œç”¨ã€‚æœ‰äº†è§£å†³æ€è·¯åï¼Œæˆ‘ä»¬å°è¯•å®ç°å®ƒï¼Œè¿™éœ€è¦é‡å†™æ•°ç»„çš„ push æ–¹æ³•ï¼Œå¦‚ä¸‹é¢çš„ä»£ç æ‰€ç¤ºï¼š

```js
// ä¸€ä¸ªæ ‡è®°å˜é‡ï¼Œ ä»£è¡¨æ˜¯å¦è¿›è¡Œè¿½è¸ªã€‚ é»˜è®¤å€¼ä¸º trueï¼Œ å³å…è®¸è¿½è¸ª
let shouldTrack = true

// é‡å†™æ•°ç»„çš„ push æ–¹æ³•
;["push"].forEach((method) => {
	// å–å¾—åŸå§‹ push æ–¹æ³•
	const originMethod = Array.prototype[method]
	// é‡å†™
	arrayInstrumentations[method] = function (...args) {
		// åœ¨è°ƒç”¨åŸå§‹æ–¹æ³•ä¹‹å‰ç¦æ­¢è¿½è¸ª
		shouldTrack = false
		// push æ–¹æ³•çš„é»˜è®¤è¡Œä¸º
		let res = originMethod.apply(this, args)
		// åœ¨è°ƒç”¨åŸå§‹æ–¹æ³•ä¹‹åï¼Œ æ¢å¤åŸæ¥çš„è¡Œä¸ºï¼Œå³å…è®¸è¿½è¸ª
		shouldTrack = true
		return res
	}
})
```

åœ¨è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªæ ‡è®°å˜é‡ shouldTrack, å®ƒæ˜¯ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œä»£è¡¨æ˜¯å¦å…è®¸è¿½è¸ªã€‚æ¥ç€ï¼Œæˆ‘ä»¬é‡å†™äº†æ•°ç»„çš„ push æ–¹æ³•ï¼Œåˆ©ç”¨äº†å‰æ–‡ä»‹ç»çš„ arrayInstrumentations å¯¹è±¡ã€‚é‡å†™åçš„ push æ–¹æ³•ä¿ç•™äº†é»˜è®¤è¡Œä¸ºï¼Œåªä¸è¿‡åœ¨æ‰§è¡Œé»˜è®¤è¡Œä¸ºä¹‹å‰ï¼Œå…ˆå°†æ ‡è®°å˜é‡ shouldTrack çš„å€¼è®¾ç½®ä¸º falseï¼Œå³ç¦æ­¢è¿½è¸ªã€‚å½“ push æ–¹æ³•çš„é»˜è®¤è¡Œä¸ºæ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œå†å°†æ ‡è®°å˜é‡ shouldTrack çš„å€¼è¿˜åŸä¸º trueï¼Œä»£è¡¨å…è®¸è¿½è¸ªã€‚æœ€åï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¿®æ”¹ track å‡½æ•°ï¼Œå¦‚ä¸‹é¢ä»£ç æ‰€ç¤º:

```js
function track(target, key) {
	// å½“ç¦æ­¢è¿½è¸ªæ—¶ï¼Œ ç›´æ¥è¿”å›
	if (!activeEffect || !shouldTrack) return
	// çœç•¥éƒ¨åˆ†ä»£ç 
}
```

å¯ä»¥çœ‹åˆ°ï¼Œå½“æ ‡è®°å˜é‡ shouldTrack çš„å€¼ä¸º false æ—¶ï¼Œå³ç¦æ­¢è¿½è¸ªæ—¶ï¼Œtrack å‡½æ•°ä¼šç›´æ¥è¿”å›ã€‚è¿™æ ·ï¼Œå½“ push æ–¹æ³•é—´æ¥è¯»å– length å±æ€§æ—¶ï¼Œç”±äºæ­¤æ—¶æ˜¯ç¦æ­¢è¿½è¸ªçŠ¶æ€ï¼Œæ‰€ä»¥ length å±æ€§ä¸å‰¯ä½œç”¨å‡½æ•°ä¹‹é—´ä¸ä¼šå»ºç«‹å“åº”è”ç³»ã€‚è¿™æ ·å°±å®ç°äº†å‰æ–‡ç»™å‡ºçš„æ–¹æ¡ˆã€‚æˆ‘ä»¬å†æ¬¡å°è¯•è¿è¡Œä¸‹é¢è¿™æ®µæµ‹è¯•ä»£ç :

```js
const arr = reactive([])

// ç¬¬ä¸€ä¸ªå‰¯ä½œç”¨å‡½æ•°
effect(() => {
	arr.push(1)
})

// ç¬¬äºŒä¸ªå‰¯ä½œç”¨å‡½æ•°
effect(() => {
	arr.push(1)
})
```

ä¼šå‘ç°å®ƒèƒ½å¤Ÿæ­£ç¡®åœ°å·¥ä½œï¼Œå¹¶ä¸”ä¸ä¼šå¯¼è‡´æ ˆæº¢å‡º

é™¤äº† push æ–¹æ³•ä¹‹å¤–ï¼Œpopã€shiftã€unshift ä»¥åŠ splice ç­‰æ–¹æ³•éƒ½éœ€è¦åšç±»ä¼¼çš„å¤„ç†ã€‚å®Œæ•´çš„ä»£ç å¦‚ä¸‹:

```js
// ä¸€ä¸ªæ ‡è®°å˜é‡ï¼Œ ä»£è¡¨æ˜¯å¦è¿›è¡Œè¿½è¸ªã€‚ é»˜è®¤å€¼ä¸º trueï¼Œ å³å…è®¸è¿½è¸ª
let shouldTrack = true

// é‡å†™æ•°ç»„çš„ pushã€popã€shiftã€unshift ä»¥åŠ splice æ–¹æ³•
;["push", "pop", "shift", "unshift", "splice"].forEach((method) => {
	// å–å¾—åŸå§‹ push æ–¹æ³•
	const originMethod = Array.prototype[method]
	// é‡å†™
	arrayInstrumentations[method] = function (...args) {
		// åœ¨è°ƒç”¨åŸå§‹æ–¹æ³•ä¹‹å‰ç¦æ­¢è¿½è¸ª
		shouldTrack = false
		// push æ–¹æ³•çš„é»˜è®¤è¡Œä¸º
		let res = originMethod.apply(this, args)
		// åœ¨è°ƒç”¨åŸå§‹æ–¹æ³•ä¹‹åï¼Œ æ¢å¤åŸæ¥çš„è¡Œä¸ºï¼Œå³å…è®¸è¿½è¸ª
		shouldTrack = true
		return res
	}
})
```
