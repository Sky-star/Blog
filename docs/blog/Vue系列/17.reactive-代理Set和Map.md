## å‰è¨€

ä»æœ¬èŠ‚å¼€å§‹ï¼Œæˆ‘ä»¬å°†ä»‹ç»é›†åˆç±»å‹æ•°æ®çš„å“åº”å¼æ–¹æ¡ˆã€‚é›†åˆç±»å‹åŒ…æ‹¬ Map/Set ä»¥åŠ WeakMap/WeakSet.ä½¿ç”¨ Proxy ä»£ç†é›†åˆç±»å‹çš„æ•°æ®ä¸ç”¨ä¸ä»£ç†æ™®é€šå¯¹è±¡ï¼Œå› ä¸ºé›†åˆç±»å‹æ•°æ®çš„æ“ä½œä¸æ™®é€šå¯¹è±¡å­˜åœ¨å¾ˆå¤§çš„ä¸åŒã€‚ä¸‹é¢æ€»ç»“äº† Set å’Œ Map è¿™ä¸¤ä¸ªæ•°æ®ç±»å‹çš„åŸå‹å±æ€§å’Œæ–¹æ³•ã€‚

Set ç±»å‹çš„åŸå‹å±æ€§å’Œæ–¹æ³•å¦‚ä¸‹ã€‚

- size: è¿”å›é›†åˆä¸­å…ƒç´ çš„æ•°é‡
- add(value): å‘é›†åˆä¸­æ·»åŠ ç»™å®šçš„å€¼
- clear(): æ¸…ç©ºç»“åˆ
- delete(value): ä»é›†åˆä¸­åˆ é™¤ç»™å®šçš„å€¼
- has(value): åˆ¤æ–­é›†åˆä¸­æ˜¯å¦å­˜åœ¨ç»™å®šçš„å€¼
- keys(): è¿”å›ä¸€ä¸ªè¿­ä»£å™¨å¯¹è±¡ã€‚å¯ç”¨äº for...of å¾ªç¯ï¼Œè¿­ä»£å™¨å¯¹è±¡äº§ç”Ÿçš„å€¼ä¸ºé›†åˆä¸­çš„å…ƒç´ å€¼
- values(): å¯¹äº Set é›†åˆæ¥è¯´ï¼Œkeys()ä¸ values()ç­‰ä»·
- entries(): è¿”å›ä¸€ä¸ªè¿­ä»£å™¨å¯¹è±¡ã€‚è¿­ä»£è¿‡ç¨‹ä¸­ä¸ºé›†åˆä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ äº§ç”Ÿä¸€ä¸ªæ•°ç»„å€¼[value, value]
- forEach(callback[, thisArg]): forEach å‡½æ•°ä¼šéå†é›†åˆä¸­çš„æ‰€æœ‰å…ƒç´ ï¼Œå¹¶å¯¹æ¯ä¸€ä¸ªå…ƒç´ è°ƒç”¨ callback å‡½æ•°ã€‚forEach å‡½æ•°æ¥æ”¶å¯é€‰çš„ç¬¬äºŒä¸ªå‚æ•° thisArg,ç”¨äºæŒ‡å®š callback å‡½æ•°æ‰§è¡Œæ—¶ this å€¼

Map ç±»å‹çš„åŸå‹å±æ€§å’Œæ–¹æ³•å¦‚ä¸‹ã€‚

- size: è¿”å› Map æ•°æ®ä¸­çš„é”®å€¼å¯¹æ•°é‡
- clear(): æ¸…ç©º Map
- delete(key): åˆ é™¤æŒ‡å®š key çš„é”®å€¼å¯¹
- has(key): åˆ¤æ–­ Map ä¸­æ˜¯å¦å­˜åœ¨æŒ‡å®š key çš„é”®å€¼å¯¹
- get(key): è¯»å–æŒ‡å®š key çš„é”®å€¼å¯¹
- set(key,value): ä¸º Map è®¾ç½®æ–°çš„é”®å€¼å¯¹
- keys(): è¿”å›ä¸€ä¸ªè¿­ä»£å™¨å¯¹è±¡ã€‚è¿­ä»£è¿‡ç¨‹ä¸­ä¼šäº§ç”Ÿé”®å€¼å¯¹çš„ key å€¼
- values(): è¿”å›ä¸€ä¸ªè¿­ä»£å™¨å¯¹è±¡ã€‚è¿­ä»£è¿‡ç¨‹ä¸­ä¼šäº§ç”Ÿé”®å€¼å¯¹çš„ value å€¼
- entires(): è¿”å›ä¸€ä¸ªè¿­ä»£å™¨å¯¹è±¡ã€‚è¿­ä»£è¿‡ç¨‹ä¸­ä¼šäº§ç”Ÿç”±[key, value]ç»„æˆçš„æ•°ç»„å€¼
- forEach(callback[, thisArg]): forEach å‡½æ•°ä¼šéå† Map æ•°æ®çš„æ‰€æœ‰é”®å€¼å¯¹ï¼Œå¹¶å¯¹æ¯ä¸€ä¸ªé”®å€¼å¯¹è°ƒç”¨ callback å‡½æ•°ã€‚forEach å‡½æ•°æ¥æ”¶å¯é€‰çš„ç¬¬äºŒä¸ªå‚æ•° thisArg,ç”¨äºæŒ‡å®š callback å‡½æ•°æ‰§è¡Œæ—¶çš„ this å€¼

è§‚å¯Ÿä¸Šè¿°åˆ—è¡¨å¯ä»¥å‘ç°ï¼ŒMap å’Œ Set è¿™ä¸¤ä¸ªæ•°æ®ç±»å‹çš„æ“ä½œæ–¹æ³•ç›¸ä¼¼ã€‚å®ƒä»¬ä¹‹é—´æœ€å¤§çš„ä¸åŒä½“ç°åœ¨ï¼ŒSet ç±»å‹ä½¿ç”¨ add(value)æ–¹æ³•æ·»åŠ å…ƒç´ ï¼Œè€Œ Map ç±»å‹ä½¿ç”¨ set(key, value)æ–¹æ³•è®¾ç½®é”®å€¼å¯¹ï¼Œå¹¶ä¸” Map ç±»å‹å¯ä»¥ä½¿ç”¨ get(key)æ–¹æ³•è¯»å–ç›¸åº”çš„å€¼ã€‚æ—¢ç„¶ä¸¤è€…å¦‚æ­¤ç›¸ä¼¼ï¼Œé‚£ä¹ˆæ˜¯ä¸æ˜¯æ„å‘³ç€æˆ‘ä»¬å¯ä»¥ç”¨ç›¸åŒçš„å¤„ç†åŠæ³•æ¥å®ç°å¯¹ä»–ä»¬çš„ä»£ç†å‘¢ï¼Ÿæ²¡é”™ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ·±å…¥æ¢è®¨å¦‚ä½•å®ç°å¯¹ Set å’Œ Map ç±»å‹æ•°æ®çš„ä»£ç†ã€‚

## å¦‚ä½•ä»£ç† Set å’Œ Map

å‰é¢è®²åˆ°ï¼Œ Set å’Œ Map ç±»å‹çš„æ•°æ®æœ‰ç‰¹å®šçš„å±æ€§å’Œæ–¹æ³•ç”¨æ¥æ“ä½œè‡ªèº«ã€‚è¿™ä¸€ç‚¹ä¸æ™®é€šå¯¹è±¡ä¸åŒï¼Œå¦‚ä¸‹é¢çš„ä»£ç æ‰€ç¤º:

```js
// æ™®é€šå¯¹è±¡çš„è¯»å–å’Œè®¾ç½®æ“ä½œ
const obj = { foo: 1 }
obj.foo // è¯»å–å±æ€§
obj.foo = 2 // è®¾ç½®å±æ€§

// ç”¨get/setæ–¹æ³•æ“ä½œ Map æ•°æ®
const map = new Map()
map.set("key", 1) // è®¾ç½®æ•°æ®
map.get("key") // è¯»å–æ•°æ®
```

æ­£æ˜¯å› ä¸ºè¿™äº›å·®å¼‚çš„å­˜åœ¨ï¼Œæˆ‘ä»¬ä¸èƒ½æƒ³ä»£ç†æ™®é€šå¯¹è±¡é‚£æ ·ä»£ç† Set å’Œ Map ç±»å‹çš„æ•°æ®ã€‚ä½†æ•´ä½“æ€è·¯ä¸å˜ï¼Œå³å½“è¯»å–å‘ç”Ÿæ—¶ï¼Œåº”è¯¥è°ƒç”¨ track å‡½æ•°å»ºç«‹å“åº”è”ç³»ï¼›å½“è®¾ç½®æ“ä½œå‘ç”Ÿæ—¶ï¼Œåº”è¯¥è°ƒç”¨ trigger å‡½æ•°è§¦å‘å“åº”ï¼Œä¾‹å¦‚:

```js
const proxy = reactive(new Map([["key", 1]]))

effect(() => {
	console.log(proxy.get("key")) // è¯»å–é”®ä¸º key çš„å€¼
})

proxy.set("key", 2) // ä¿®æ”¹é”®ä¸º key çš„å€¼ï¼Œåº”è¯¥è§¦å‘å“åº”
```

å½“ç„¶ï¼Œè¿™æ®µä»£ç å±•ç¤ºçš„æ•ˆæœæ˜¯æˆ‘ä»¬æœ€ç»ˆè¦å®ç°çš„ç›®æ ‡ã€‚ä½†åœ¨åŠ¨æ‰‹ä¹‹å‰ï¼Œæˆ‘ä»¬æœ‰å¿…è¦å…ˆäº†è§£å…³äºä½¿ç”¨ Proxy ä»£ç† Set æˆ– Map ç±»å‹æ•°æ®çš„æ³¨æ„äº‹é¡¹ã€‚

å…ˆæ¥çœ‹ä¸€æ®µä»£ç ï¼Œå¦‚ä¸‹ï¼š

```js
const s = new Set([1, 2, 3])
const p = new Proxy(s, {})

console.log(p.size) // æŠ¥é”™ TypeError: Method get Set.prototype.size called on incompatible receiver
```

åœ¨è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆå®šä¹‰äº†ä¸€ä¸ª Set ç±»å‹çš„æ•°æ® sï¼Œæ¥ç€ä¸ºå®ƒåˆ›å»ºä¸€ä¸ªä»£ç†å¯¹è±¡ pã€‚ç”±äºä»£ç†çš„ç›®æ ‡å¯¹è±¡æ˜¯ Set ç±»å‹ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡è¯»å–å®ƒçš„ p.size å±æ€§è·å–å…ƒç´ çš„æ•°é‡ã€‚ä½†ä¸å¹¸çš„æ˜¯ï¼Œæˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ªé”™è¯¯ã€‚é”™è¯¯ä¿¡æ¯çš„å¤§æ„æ˜¯â€œåœ¨ä¸å…¼å®¹ receiver ä¸Šè°ƒç”¨äº† get Set.prototype.size æ–¹æ³•â€ã€‚ç”±æ­¤æˆ‘ä»¬å¤§æ¦‚èƒ½çŒœåˆ°ï¼Œsize å±æ€§åº”è¯¥æ˜¯ä¸€ä¸ªè®¿é—®å™¨å±æ€§ï¼Œæ‰€ä»¥å®ƒä½œä¸ºæ–¹æ³•è¢«è°ƒç”¨äº†ã€‚é€šè¿‡è§„èŒƒ 24.2.3.9 æŸ¥é˜…å¯ä»¥è¯å®è¿™ä¸€ç‚¹,å¦‚å›¾æ‰€ç¤ºã€‚

![img](../assets/VueImage/ECMA-262-Set-get.png)

Set.prototype.size æ˜¯ä¸€ä¸ªè®¿é—®å™¨å±æ€§ï¼Œå®ƒçš„ set è®¿é—®å™¨å‡½æ•°æ˜¯ undefinedï¼Œå®ƒçš„ get è®¿é—®å™¨å‡½æ•°ä¼šæ‰§è¡Œä»¥ä¸‹æ­¥éª¤ã€‚

1. è®© S çš„å€¼ä¸º this
2. æ‰§è¡Œ ? RequireInternalSlot(S, [[SetData]])
3. è®© count çš„å€¼ä¸º 0
4. å¯¹äº S.[[SetData]]ä¸­çš„æ¯ä¸ªå…ƒç´  eï¼Œæ‰§è¡Œ:

   a. å¦‚æœ e ä¸æ˜¯ç©ºçš„ï¼Œåˆ™å°† count è®¾ç½®ä¸º count + 1

5. è¿”å› ğ”½(count)

ç”±æ­¤å¯çŸ¥ï¼Œ Set.prototype.size æ˜¯ä¸€ä¸ªè®¿é—®å™¨å±æ€§ã€‚è¿™é‡Œçš„å…³é”®ç‚¹åœ¨äºç¬¬ 1 æ­¥å’Œç¬¬ 2 æ­¥ã€‚æ ¹æ®ç¬¬ 1 æ­¥çš„æè¿°: è®© S çš„å€¼ä¸º thisã€‚è¿™é‡Œçš„ this æ˜¯è°å‘¢ï¼Ÿ
ç”±äºæˆ‘ä»¬é€šè¿‡æ˜¯é€šè¿‡ä»£ç†å¯¹è±¡ p æ¥è®¿é—® size å±æ€§çš„ï¼Œæ‰€ä»¥ this å°±æ˜¯ä»£ç†å¯¹è±¡ pã€‚æ¥ç€åœ¨ç¬¬ 2 æ­¥ä¸­ï¼Œè°ƒç”¨æŠ½è±¡æ–¹æ³• RequireInternalSlot(S, [[SetData]])æ¥æ£€æŸ¥ S æ˜¯å¦å­˜åœ¨å†…éƒ¨æ§½[[SetData]]ã€‚å¾ˆæ˜¾ç„¶ï¼Œä»£ç†å¯¹è±¡ S ä¸å­˜åœ¨[[SetData]]è¿™ä¸ªå†…éƒ¨æ§½ï¼Œäºæ˜¯ä¼šæŠ›å‡ºä¸€ä¸ªé”™è¯¯ï¼Œä¹Ÿå°±æ˜¯å‰é¢ä¾‹å­ä¸­å¾—åˆ°çš„é”™è¯¯ã€‚

ä¸ºäº†ä¿®å¤è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ­£è®¿é—®å™¨å±æ€§çš„ getter å‡½æ•°æ‰§è¡Œæ—¶çš„ this æŒ‡å‘ï¼Œå¦‚ä¸‹é¢çš„ä»£ç æ‰€ç¤º:

```js
const s = new Set([1, 2, 3])
const p = new Proxy(s, {
	get(target, key, receiver) {
		if (key === "size") {
			// å¦‚æœè¯»å–çš„æ˜¯ size å±æ€§
			// é€šè¿‡æŒ‡å®šç¬¬ä¸‰ä¸ªå‚æ•° receiver ä¸ºåŸå§‹å¯¹è±¡ target ä»è€Œä¿®å¤é—®é¢˜
			return Reflect.get(target, key, target)
		}
		// è¯»å–å…¶ä»–å±æ€§çš„çš„é»˜è®¤è¡Œä¸º
		return Reflect.get(target, key, receiver)
	}
})

console.log(s.size) // 3
```

ä¸Šé¢è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬åœ¨åˆ›å»ºä»£ç†å¯¹è±¡æ—¶å¢åŠ äº† get æ‹¦æˆªå‡½æ•°ã€‚ç„¶åæ£€æŸ¥è¯»å–çš„å±æ€§åç§°æ˜¯ä¸æ˜¯ sizeï¼Œå¦‚æœæ˜¯ï¼Œåˆ™åœ¨è°ƒç”¨ Reflect.get å‡½æ•°æ—¶æŒ‡å®šç¬¬ä¸‰ä¸ªå‚æ•°ä¸ºåŸå§‹ Set å¯¹è±¡ï¼Œè¿™æ ·è®¿é—®å™¨å±æ€§ size çš„ getter å‡½æ•°åœ¨æ‰§è¡Œæ—¶ï¼Œå…¶ this æŒ‡å‘çš„å°±æ˜¯åŸå§‹ Set å¯¹è±¡è€Œéä»£ç†å¯¹è±¡äº†ã€‚ç”±äºåŸå§‹ Set å¯¹è±¡ä¸Šå­˜åœ¨[[SetData]]å†…éƒ¨æ§½ï¼Œå› æ­¤ç¨‹åºå¾—ä»¥æ­£ç¡®è¿è¡Œã€‚

æ¥ç€ï¼Œæˆ‘ä»¬å†æ¥å°è¯•ä» Set ä¸­åˆ é™¤æ•°æ®ï¼Œå¦‚ä¸‹é¢çš„ä»£ç æ‰€ç¤º:

```js
const s = new Set([1, 2, 3])
const p = new Proxy(s, {
	get(target, key, receiver) {
		if (key === "size") {
			return Reflect.get(target, key, target)
		}
		// è¯»å–å…¶ä»–å±æ€§çš„çš„é»˜è®¤è¡Œä¸º
		return Reflect.get(target, key, receiver)
	}
})

// è°ƒç”¨ deleteæ–¹æ³•åˆ é™¤å€¼ä¸º 1 çš„å…ƒç´ 
// ä¼šå¾—åˆ°é”™è¯¯ TypeError: Method Set.prototype.delete called on incompatible receiver [object Object]
p.delete(1)
```

å¯ä»¥çœ‹åˆ°ï¼Œè°ƒç”¨ P.delete æ–¹æ³•æ—¶ä¼šå¾—åˆ°ä¸€ä¸ªé”™è¯¯ï¼Œè¿™ä¸ªé”™è¯¯ä¸å‰æ–‡è®²è§£çš„è®¿é—® p.size å±æ€§æ—¶å‘ç”Ÿçš„é”™è¯¯éå¸¸ç›¸ä¼¼ã€‚ä¸ºäº†ææ¸…æ¥šé—®é¢˜çš„åŸå› ï¼Œæˆ‘ä»¬éœ€è¦è¯¦ç»†åˆ†æå½“è°ƒç”¨ p.delete(1)æ–¹æ³•æ—¶éƒ½å‘ç”Ÿäº†ä»€ä¹ˆã€‚

å®é™…ä¸Šï¼Œè®¿é—® p.size ä¸è®¿é—® p.delete æ˜¯ä¸åŒçš„ã€‚è¿™æ˜¯å› ä¸º size æ˜¯å±æ€§ï¼Œæ˜¯ä¸€ä¸ªè®¿é—®å™¨å±æ€§ï¼Œè€Œ delete æ˜¯ä¸€ä¸ªæ–¹æ³•ã€‚å½“è®¿é—® p.size æ—¶ï¼Œè®¿é—®å™¨å±æ€§çš„ getter å‡½æ•°ä¼šç«‹å³æ‰§è¡Œã€‚æ­¤æ—¶æˆ‘ä»¬å¯ä»¥ç”¨è¿‡ä¿®æ”¹ receiver æ¥æ”¹å˜ getter å‡½æ•°çš„ this æŒ‡å‘ã€‚è€Œå½“è®¿é—® p.delete æ—¶ï¼Œdelete æ–¹æ³•å¹¶æ²¡æœ‰æ‰§è¡Œï¼ŒçœŸæ­£ä½¿å…¶æ‰§è¡Œçš„è¯­å¥æ˜¯ p.delete(1)è¿™å¥å‡½æ•°è°ƒç”¨ã€‚å› æ­¤ï¼Œæ— è®ºæ€ä¹ˆä¿®æ”¹ receiverï¼Œdelete æ–¹æ³•æ‰§è¡Œæ—¶çš„ this éƒ½ä¼šæŒ‡å‘ä»£ç†å¯¹è±¡ p,è€Œä¸ä¼šæŒ‡å‘åŸå§‹ Set å¯¹è±¡ã€‚æƒ³è¦ä¿®å¤è¿™ä¸ªé—®é¢˜ä¹Ÿä¸éš¾ï¼Œåªéœ€è¦æŠŠ delete æ–¹æ³•ä¸åŸå§‹æ•°æ®å¯¹è±¡ç»‘å®šå³å¯ï¼Œå¦‚ä»¥ä¸‹ä»£ç :

```js
const s = new Set([1, 2, 3])
const p = new Proxy(s, {
	get(target, key, receiver) {
		if (key === "size") {
			return Reflect.get(target, key, target)
		}
		// å°†æ–¹æ³•ä¸åŸå§‹æ•°æ®å¯¹è±¡ target æ¯”ç»‘å®šåè¿”å›
		return target[key].bind(target)
	}
})

// è°ƒç”¨ deleteæ–¹æ³•åˆ é™¤å€¼ä¸º 1 çš„å…ƒç´ , æ­£ç¡®æ‰§è¡Œ
p.delete(1)
```

åœ¨ä¸Šé¢è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ target[key].bind(target)ä»£æ›¿äº† Reflect.get(target,key,receiver)ã€‚å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬ä½¿ç”¨ bind å‡½æ•°å°†ç”¨äºæ“ä½œæ•°æ®çš„æ–¹æ³•ä¸åŸå§‹æ•°æ®å¯¹è±¡ target åšäº†ç»‘å®šã€‚è¿™æ ·å½“ p.delete(1)è¯­å¥æ‰§è¡Œæ—¶ï¼Œdelete å‡½æ•°çš„ this æ€»æ˜¯æŒ‡å‘åŸå§‹æ•°æ®å¯¹è±¡è€Œéä»£ç†å¯¹è±¡ï¼Œäºæ˜¯ä»£ç èƒ½å¤Ÿæ­£ç¡®æ‰§è¡Œã€‚

æœ€åï¼Œä¸ºäº†åç»­è®²è§£æ–¹ä¾¿ä»¥åŠä»£ç çš„å¯æ‰©å±•æ€§ï¼Œæˆ‘ä»¬å°† new Proxy ä¹Ÿå°è£…åˆ°å‰æ–‡ä»‹ç»çš„ createReactive å‡½æ•°ä¸­:

```js
const reactiveMap = new Map()
// reactive å‡½æ•°ä¸ä¹‹å‰ç›¸æ¯”å¹¶æ²¡æœ‰å˜åŒ–
function reactive(obj) {
	const existProxy = reactiveMap.get(obj)
	if (existProxy) return existProxy
	const proxy = createReactive(obj)

	reactiveMap.set(obj, proxy)

	return proxy
}
// åœ¨ createReactive é‡Œå°è£…äº†ç”¨äºä»£ç† Set/Map ç±»å‹æ•°æ®çš„é€»è¾‘
function createReactive(obj, isShallow = false, isReadonly = false) {
	return new Proxy(obj, {
		get(target, key, receiver) {
			if (key === "size") {
				return Reflect.get(target, key, target)
			}

			return target[key].bind(target)
		}
	})
}
```

è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¾ˆç®€å•åœ°åˆ›å»ºä»£ç†æ•°æ®äº†:

```js
const p = reactive(new Set([1, 2, 3]))
console.log(p.size) // 3
```

## å»ºç«‹å“åº”è”ç³»

äº†è§£äº†ä¸º Set å’Œ Map ç±»å‹æ•°æ®åˆ›å»ºä»£ç†æ—¶çš„æ³¨æ„äº‹é¡¹ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥ç€æ‰‹å®ç° Set ç±»å‹æ•°æ®çš„å“åº”å¼æ–¹æ¡ˆäº†ã€‚å…¶å®æ€è·¯å¹¶ä¸å¤æ‚ï¼Œä»¥ä¸‹é¢çš„ä»£ç ä¸ºä¾‹:

```js
const p = reactive(new Set([1, 2, 3]))

effect(() => {
	// åœ¨å‰¯ä½œç”¨å‡½æ•°ä¸­è®¿é—® size å±æ€§
	console.log(p.size)
})

// æ·»åŠ å€¼ä¸º 1 çš„å…ƒç´ ï¼Œ åº”è¯¥è§¦å‘å“åº”
p.add(1)
```

è¿™æ®µä»£ç å±•ç¤ºäº†å“åº”å¼ Set ç±»å‹æ•°æ®çš„å·¥ä½œæ–¹å¼ã€‚é¦–å…ˆï¼Œåœ¨å‰¯ä½œç”¨å‡½æ•°å†…è®¿é—®äº† p.size å±æ€§ï¼›æ¥ç€ï¼Œè°ƒç”¨ p.add å‡½æ•°å‘é›†åˆä¸­æ·»åŠ æ•°æ®ã€‚ç”±äºè¿™ä¸ªè¡Œä¸ºä¼šé—´æ¥æ”¹å˜é›†åˆçš„ size å±æ€§å€¼ï¼Œæ‰€ä»¥æˆ‘ä»¬æœŸæœ›å‰¯ä½œç”¨å‡½æ•°ä¼šé‡æ–°æ‰§è¡Œã€‚ä¸ºäº†å®ç°è¿™ä¸ªç›®æ ‡ï¼Œæˆ‘ä»¬éœ€è¦åœ¨è®¿é—® size å±æ€§æ—¶è°ƒç”¨ track å‡½æ•°è¿›è¡Œä¾èµ–è¿½è¸ªï¼Œç„¶ååœ¨ add æ–¹æ³•æ‰§è¡Œæ—¶è°ƒç”¨ trigger å‡½æ•°è§¦å‘å“åº”ã€‚ä¸‹é¢çš„ä»£ç å±•ç¤ºäº†å¦‚ä½•è¿›è¡Œä¾èµ–è¿½è¸ª:

```js
function createReactive(obj, isShallow = false, isReadonly = false) {
	return new Proxy(obj, {
		get(target, key, receiver) {
			if (key === "size") {
				// è°ƒç”¨ track å‡½æ•°å»ºç«‹å“åº”è”ç³»
				track(target, ITERATE_KEY)
				return Reflect.get(target, key, target)
			}

			return target[key].bind(target)
		}
	})
}
```

å¯ä»¥çœ‹åˆ°ï¼Œå½“è¯»å– size å±æ€§æ—¶ï¼Œåªéœ€è¦è°ƒç”¨ track å‡½æ•°å»ºç«‹å“åº”è”ç³»å³å¯ã€‚è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå“åº”è”ç³»éœ€è¦å»ºç«‹åœ¨ ITERATE_KEY ä¸å‰¯ä½œç”¨å‡½æ•°ä¹‹é—´ï¼Œè¿™æ˜¯å› ä¸ºä»»ä½•æ–°å¢ã€åˆ é™¤æ“ä½œéƒ½ä¼šå½±å“ size å±æ€§ã€‚æ¥ç€ï¼Œæˆ‘ä»¬æ¥çœ‹å¦‚ä½•è§¦å‘å“åº”ã€‚å½“è°ƒç”¨ add æ–¹æ³•å‘é›†åˆä¸­æ·»åŠ æ–°å…ƒç´ æ—¶ï¼Œåº”è¯¥æ€ä¹ˆè§¦å‘å“åº”å‘¢ï¼Ÿå¾ˆæ˜¾ç„¶ï¼Œè¿™éœ€è¦æˆ‘ä»¬å®ç°ä¸€ä¸ªè‡ªå®šä¹‰çš„ add æ–¹æ³•æ‰è¡Œï¼Œå¦‚ä»¥ä¸‹ä»£ç æ‰€ç¤º:

```js
// å®šä¹‰ä¸€ä¸ªå¯¹è±¡, å°†è‡ªå®šä¹‰çš„addæ–¹æ³•å®šä¹‰åˆ°è¯¥å¯¹è±¡ä¸‹
const mutableInstrumentations = {
	add(key) {
		/* ... */
	}
}

function createReactive(obj, isShallow = false, isReadonly = false) {
	return new Proxy(obj, {
		get(target, key, receiver) {
			// å¦‚æœè¯»å–çš„æ˜¯ raw å±æ€§ï¼Œ åˆ™è¿”å›åŸå§‹æ•°æ® target
			if (key === "raw") return target
			if (key === "size") {
				track(target, ITERATE_KEY)
				return Reflect.get(target, key, target)
			}

			// è¿”å›å®šä¹‰åœ¨ mutableInstrumentations å¯¹è±¡ä¸‹çš„æ–¹æ³•
			return mutableInstrumentations[key]
		}
	})
}
```

é¦–å…ˆï¼Œå®šä¹‰ä¸€ä¸ªå¯¹è±¡ mutableInstrumentationsï¼Œæˆ‘ä»¬ä¼šå°†æ‰€æœ‰è‡ªå®šä¹‰å®ç°çš„æ–¹æ³•éƒ½å®šä¹‰åˆ°è¯¥å¯¹è±¡ä¸‹ï¼Œä¾‹å¦‚ mutableInstrumentations.add æ–¹æ³•ã€‚ç„¶åï¼Œåœ¨ get æ‹¦æˆªå‡½æ•°å†…è¿”å›å®šä¹‰åœ¨ mutableInstrumentations å¯¹è±¡ä¸­çš„æ–¹æ³•ã€‚è¿™æ ·ï¼Œå½“é€šè¿‡ p.add è·å–æ–¹æ³•æ—¶ï¼Œå¾—åˆ°çš„å°±æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„ mutableInstrumentations.add æ–¹æ³•äº†ã€‚æœ‰äº†è‡ªå®šä¹‰å®ç°çš„æ–¹æ³•åï¼Œå°±å¯ä»¥åœ¨å…¶ä¸­è°ƒç”¨ trigger å‡½æ•°è§¦å‘å“åº”äº†:

```js
const mutableInstrumentations = {
	add(key) {
		// this ä»ç„¶æŒ‡å‘çš„æ˜¯ä»£ç†å¯¹è±¡ï¼Œ é€šè¿‡ raw å±æ€§è·å–åŸå§‹æ•°æ®å¯¹è±¡
		const target = this.raw
		// é€šè¿‡åŸå§‹æ•°æ®å¯¹è±¡æ‰§è¡Œ add æ–¹æ³•æ·»åŠ å…·ä½“çš„å€¼
		// æ³¨æ„ï¼Œè¿™é‡Œä¸å†éœ€è¦ .bindäº†ï¼Œå› ä¸ºæ˜¯ç›´æ¥é€šè¿‡ target è°ƒç”¨å¹¶æ‰§è¡Œçš„
		const res = target.add(key)
		// è°ƒç”¨ trigger å‡½æ•°è§¦å‘å“åº”ï¼Œ å¹¶æŒ‡å®šæ“ä½œç±»å‹ä¸º ADD
		trigger(target, key, "ADD")
		// è¿”å›æ“ä½œç»“æœ
		return res
	}
}
```

å¦‚ä¸Šé¢çš„ä»£ç æ‰€ç¤ºï¼Œè‡ªå®šä¹‰çš„ add å‡½æ•°å†…çš„ this ä»ç„¶æŒ‡å‘ä»£ç†å¯¹è±¡ï¼Œæ‰€ä»¥éœ€è¦é€šè¿‡ this.raw è·å–åŸå§‹æ•°æ®å¯¹è±¡ã€‚æœ‰äº†åŸå§‹æ•°æ®å¯¹è±¡åï¼Œå°±å¯ä»¥é€šè¿‡å®ƒè°ƒç”¨ target.add æ–¹æ³•ï¼Œè¿™æ ·å°±ä¸å†éœ€è¦ .bind ç»‘å®šäº†ã€‚å¾…æ·»åŠ æ“ä½œå®Œæˆåï¼Œè°ƒç”¨ trigger å‡½æ•°è§¦å‘å“åº”ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬æŒ‡å®šäº†æ“ä½œç±»å‹ä¸º ADDï¼Œè¿™ä¸€ç‚¹å¾ˆé‡è¦ã€‚è¿˜è®°å¾— trigger å‡½æ•°çš„å®ç°ï¼Ÿæˆ‘ä»¬æ¥å›é¡¾ä¸€ä¸‹ï¼Œå¦‚ä¸‹é¢çš„ä»£ç ç‰‡æ®µæ‰€ç¤º:

```js
function trigger(target, key, type, newVal) {
	const depsMap = bucket.get(target)
	if (!depsMap) return
	const effects = depsMap.get(key)

	// çœç•¥æ— å…³å†…å®¹

	// å½“æ“ä½œç±»å‹ type ä¸º ADD æ—¶ï¼Œä¼šå–å‡ºä¸ ITERATE_KEY ç›¸å…³è”çš„å‰¯ä½œç”¨å‡½æ•°å¹¶æ‰§è¡Œ
	if (type === "ADD" || type === "DELETE") {
		const iterateEffects = depsMap.get(ITERATE_KEY)
		iterateEffects &&
			iterateEffects.forEach((effectFn) => {
				if (effectFn !== activeEffect) {
					effectsToRun.add(effectFn)
				}
			})
	}

	effectsToRun.forEach((effectFn) => {
		if (effectFn.options.scheduler) {
			effectFn.options.scheduler(effectFn)
		} else {
			effectFn()
		}
	})
}
```

å½“æ“ä½œç±»å‹æ—¶ ADD æˆ– Delete æ—¶ï¼Œä¼šå–å‡ºä¸ ITERATE_KEY ç›¸å…³è”çš„å‰¯ä½œç”¨å‡½æ•°å¹¶æ‰§è¡Œï¼Œè¿™æ ·å°±å¯ä»¥è§¦å‘é€šè¿‡è®¿é—® size å±æ€§æ‰€æ”¶é›†çš„å‰¯ä½œç”¨å‡½æ•°æ¥æ‰§è¡Œäº†ã€‚

å½“ç„¶ï¼Œå¦‚æœè°ƒç”¨ add æ–¹æ³•æ·»åŠ çš„å…ƒç´ å·²ç»å­˜åœ¨äº Set é›†åˆä¸­äº†ï¼Œå°±ä¸è¦å†è§¦å‘å“åº”äº†ï¼Œè¿™æ ·åšå¯¹æ€§èƒ½æ›´åŠ å‹å¥½ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹ä»£ç åšå¦‚ä¸‹ä¼˜åŒ–:

```js
const mutableInstrumentations = {
	add(key) {
		// this ä»ç„¶æŒ‡å‘çš„æ˜¯ä»£ç†å¯¹è±¡ï¼Œ é€šè¿‡ raw å±æ€§è·å–åŸå§‹æ•°æ®å¯¹è±¡
		const target = this.raw
		// å…ˆåˆ¤æ–­å€¼æ˜¯å¦å·²ç»å­˜åœ¨
		const hadKey = target.has(key)
		// é€šè¿‡åŸå§‹æ•°æ®å¯¹è±¡æ‰§è¡Œ add æ–¹æ³•æ·»åŠ å…·ä½“çš„å€¼
		// æ³¨æ„ï¼Œè¿™é‡Œä¸å†éœ€è¦ .bindäº†ï¼Œå› ä¸ºæ˜¯ç›´æ¥é€šè¿‡ target è°ƒç”¨å¹¶æ‰§è¡Œçš„
		const res = target.add(key)
		// è°ƒç”¨ trigger å‡½æ•°è§¦å‘å“åº”ï¼Œ å¹¶æŒ‡å®šæ“ä½œç±»å‹ä¸º ADD
		// åªæœ‰åœ¨å€¼ä¸å­˜åœ¨çš„æƒ…å†µä¸‹ï¼Œæ‰éœ€è¦è§¦å‘å“åº”
		if (!hadKey) {
			trigger(target, key, "ADD")
		}
		// è¿”å›æ“ä½œç»“æœ
		return res
	}
}
```

åœ¨ä¸Šé¢è¿™æ®µä»£ç ä¸­ï¼Œ æˆ‘ä»¬å…ˆè°ƒç”¨ target.has æ–¹æ³•åˆ¤æ–­å€¼æ˜¯å¦å·²ç»å­˜åœ¨ï¼Œåªæœ‰åœ¨å€¼ä¸å­˜åœ¨çš„æƒ…å†µæ‰éœ€è¦è§¦å‘å“åº”ã€‚

åœ¨æ­¤åŸºç¡€ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥æŒ‰ç…§ç±»ä¼¼çš„æ€è·¯è½»æ¾åœ°å®ç° delete æ–¹æ³•:

```js
const mutableInstrumentations = {
	delete(key) {
		// this ä»ç„¶æŒ‡å‘çš„æ˜¯ä»£ç†å¯¹è±¡ï¼Œ é€šè¿‡ raw å±æ€§è·å–åŸå§‹æ•°æ®å¯¹è±¡
		const target = this.raw
		// å…ˆåˆ¤æ–­å€¼æ˜¯å¦å·²ç»å­˜åœ¨
		const hadKey = target.has(key)
		// é€šè¿‡åŸå§‹æ•°æ®å¯¹è±¡æ‰§è¡Œ delete æ–¹æ³•åˆ é™¤å…·ä½“çš„å€¼
		// æ³¨æ„ï¼Œè¿™é‡Œä¸å†éœ€è¦ .bindäº†ï¼Œå› ä¸ºæ˜¯ç›´æ¥é€šè¿‡ target è°ƒç”¨å¹¶æ‰§è¡Œçš„
		const res = target.delete(key)
		// è°ƒç”¨ trigger å‡½æ•°è§¦å‘å“åº”ï¼Œ å¹¶æŒ‡å®šæ“ä½œç±»å‹ä¸º DELETE
		// åªæœ‰åœ¨è¦åˆ é™¤çš„å€¼å­˜åœ¨çš„æƒ…å†µä¸‹ï¼Œæ‰éœ€è¦è§¦å‘å“åº”
		if (hadKey) {
			trigger(target, key, "DELETE")
		}
		// è¿”å›æ“ä½œç»“æœ
		return res
	}
}
```

å¦‚ä¸Šé¢ä»£ç æ‰€ç¤ºï¼Œä¸ add æ–¹æ³•çš„åŒºåˆ«åœ¨äºï¼Œdelete æ–¹æ³•åªæœ‰åœ¨è¦åˆ é™¤çš„å…ƒç´ åœ¨é›†åˆä¸­å­˜åœ¨æ—¶ï¼Œæ‰éœ€è¦è§¦å‘å“åº”ï¼Œè¿™ä¸€ç‚¹æ°å¥½ä¸ add æ–¹æ³•ç›¸åã€‚

## é¿å…æ±¡æŸ“åŸå§‹æ•°æ®

æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å€ŸåŠ© Map ç±»å‹çš„ set å’Œ get è¿™ä¸¤ä¸ªæ–¹æ³•æ¥è®²è§£ä»€ä¹ˆæ˜¯â€œé¿å…æ±¡æŸ“åŸå§‹æ•°æ®â€åŠå…¶åŸå› ã€‚

Map æ•°æ®ç±»å‹æ‹¥æœ‰ get å’Œ set è¿™ä¸¤ä¸ªæ–¹æ³•ï¼Œå½“è°ƒç”¨ get æ–¹æ³•è¯»å–æ•°æ®æ—¶ï¼Œéœ€è¦è°ƒç”¨ track å‡½æ•°è¿½è¸ªä¹Ÿä¾èµ–å»ºç«‹å“åº”è”ç³»ï¼›å½“è°ƒç”¨ set æ–¹æ³•è®¾ç½®æ•°æ®æ—¶ï¼Œéœ€è¦è°ƒç”¨ trigger æ–¹æ³•è§¦å‘å“åº”ã€‚å¦‚ä¸‹é¢çš„ä»£ç æ‰€ç¤º:

```js
const p = reactive(new Map([["key", 1]]))

effect(() => {
	console.log(p.get("key"))
})

p.set("key", 2) // è§¦å‘å“åº”
```

å…¶å®æƒ³è¦å®ç°ä¸Šé¢è¿™æ®µä»£ç æ‰€å±•ç¤ºçš„åŠŸèƒ½å¹¶ä¸éš¾ï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»æœ‰äº†å®ç° addã€delete ç­‰æ–¹æ³•çš„ç»éªŒã€‚ä¸‹é¢æ˜¯ get æ–¹æ³•çš„å…·ä½“å®ç°:

```js
const mutableInstrumentations = {
	get(key) {
		// è·å–åŸå§‹å¯¹è±¡
		const target = this.raw
		// åˆ¤æ–­è¯»å–çš„ key æ˜¯å¦å­˜åœ¨
		const had = target.has(key)
		// è¿½è¸ªä¾èµ– å»ºç«‹å“åº”è”ç³»
		track(target, key)
		// å¦‚æœå­˜åœ¨ï¼Œåˆ™è¿”å›ç»“æœã€‚ è¿™é‡Œè¦æ³¨æ„çš„æ˜¯ï¼Œ å¦‚æœå¾—åˆ°çš„ç»“æœ res ä»ç„¶æ˜¯å¯ä»£ç†çš„æ•°æ®ï¼Œ
		// åˆ™è¦è¿”å›ä½¿ç”¨ reactive åŒ…è£…åçš„å“åº”å¼æ•°æ®
		if (had) {
			const res = target.get(key)
			return typeof res === "object" ? reactive(res) : res
		}
	}
}
```

å¦‚ä¸Šé¢çš„ä»£ç åŠæ³¨é‡Šæ‰€ç¤ºï¼Œ æ•´ä½“æ€è·¯éå¸¸æ¸…æ™°ã€‚è¿™é‡Œæœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼Œ åœ¨éæµ…å“åº”çš„æƒ…å†µä¸‹ï¼Œ å¦‚æœå¾—åˆ°çš„æ•°æ®ä»ç„¶å¯ä»¥è¢«ä»£ç†ï¼Œé‚£ä¹ˆè¦è°ƒç”¨ reactive(res)å°†æ•°æ®è½¬æ¢æˆå“åº”å¼æ•°æ®åè¿”å›ã€‚åœ¨æµ…å“åº”æ¨¡å¼ä¸‹ï¼Œå°±ä¸éœ€è¦è¿™ä¸€æ­¥äº†ã€‚ ç”±äºå‰æ–‡ è®²è§£è¿‡å¦‚ä½•å®ç°æµ…å“åº”ï¼Œå› æ­¤è¿™é‡Œä¸å†è¯¦ç»†è®¨è®ºã€‚

æ¥ç€ï¼Œæˆ‘ä»¬æ¥è®¨è®º set æ–¹æ³•çš„å®ç°ã€‚ ç®€å•æ¥è¯´ï¼Œå½“ set æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œéœ€è¦è°ƒç”¨ trigger æ–¹æ³•è§¦å‘å“åº”ã€‚åªä¸è¿‡åœ¨è§¦å‘å“åº”çš„æ—¶å€™ï¼Œéœ€è¦åŒºåˆ†æ“ä½œç±»å‹æ—¶ SET è¿˜æ˜¯ ADDï¼Œå¦‚ä¸‹é¢çš„ä»£ç æ‰€ç¤º:

```js
const mutableInstrumentations = {
	set(key, value) {
		const target = this.raw
		const had = target.has(key)
		// è·å–æ—§å€¼
		const oldValue = target.get(key)
		// è®¾ç½®æ–°å€¼
		target.set(key, value)
		// å¦‚æœä¸å­˜åœ¨ï¼Œ åˆ™è¯´æ˜æ˜¯ ADD ç±»å‹çš„æ“ä½œï¼Œ æ„å‘³ç€æ–°å¢
		if (!had) {
			trigger(target, key, "ADD")
		} else if (oldValue !== value || (oldValue === oldValue && value === value)) {
			// å¦‚æœå­˜åœ¨ï¼Œå¹¶ä¸”å€¼å˜äº†ï¼Œ åˆ™æ˜¯ SETç±»å‹çš„æ“ä½œï¼Œæ„å‘³ç€ä¿®æ”¹
			trigger(target, key, "SET")
		}
	}
}
```

è¿™æ®µä»£ç çš„å…³é”®ç‚¹åœ¨äºï¼Œæˆ‘ä»¬éœ€è¦åˆ¤æ–­è®¾ç½®çš„ key æ˜¯å¦å­˜åœ¨ï¼Œä»¥ä¾¿åŒºåˆ†ä¸åŒçš„æ“ä½œç±»å‹ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œå¯¹äº SET ç±»å‹å’Œ ADD ç±»å‹çš„æ“ä½œæ¥è¯´ï¼Œå®ƒä»¬æœ€ç»ˆè§¦å‘çš„å‰¯ä½œç”¨å‡½æ•°æ˜¯ä¸åŒçš„ã€‚å› ä¸º ADD ç±»å‹ä¼šå¯¹æ•°æ®çš„ size å±æ€§äº§ç”Ÿå½±å“ï¼Œæ‰€ä»¥ä»»ä½•ä¾èµ– size å±æ€§çš„å‰¯ä½œç”¨å‡½æ•°éƒ½éœ€è¦åœ¨ ADD ç±»å‹çš„æ“ä½œå‘ç”Ÿæ—¶é‡æ–°æ‰§è¡Œã€‚

ä¸Šé¢ç»™å‡ºçš„ set å‡½æ•°çš„å®ç°èƒ½å¤Ÿæ­£å¸¸å·¥ä½œï¼Œä½†å®ƒä»ç„¶å­˜åœ¨é—®é¢˜ï¼Œå³ set æ–¹æ³•ä¼šæ±¡æŸ“åŸå§‹æ•°æ®ã€‚è¿™æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿ æ¥çœ‹ä¸‹é¢çš„ä»£ç :

```js
// åŸå§‹ Map å¯¹è±¡ m
const m = new Map()
// p1 æ˜¯ m çš„ä»£ç†å¯¹è±¡
const p1 = reactive(m)
// p2 æ˜¯å¦å¤–ä¸€ä¸ªä»£ç†å¯¹è±¡
const p2 = reactive(new Map())
// ä¸º p1 è®¾ç½®ä¸€ä¸ªé”®å€¼å¯¹ï¼Œ å€¼æ˜¯ä»£ç†å¯¹è±¡ p2
p1.set("p2", p2)

effect(() => {
	// æ³¨æ„ï¼Œè¿™é‡Œæˆ‘ä»¬é€šè¿‡åŸå§‹æ•°æ® m è®¿é—® p2
	console.log(m.get("p2").size)
})

// æ³¨æ„ï¼Œè¿™é‡Œæˆ‘ä»¬é€šè¿‡åŸå§‹æ•°æ® m ä¸º p2 è®¾ç½®ä¸€ä¸ªé”®å€¼å¯¹ foo => 1
m.get("p2").set("foo", 1)
```

åœ¨è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆåˆ›å»ºäº†ä¸€ä¸ªåŸå§‹ Map å¯¹è±¡ mï¼Œp1 æ˜¯å¯¹è±¡ m çš„ä»£ç†å¯¹è±¡ï¼Œæ¥ç€åˆ›å»ºå¦å¤–ä¸€ä¸ªä»£ç†å¯¹è±¡ p2ï¼Œå¹¶å°†å…¶ä½œä¸ºå€¼è®¾ç½®ç»™ p1ï¼Œå³ p1.set('p2',p2)ã€‚æ¥ä¸‹æ¥é—®é¢˜å‡ºç°äº†ï¼Œåœ¨å‰¯ä½œç”¨å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡åŸå§‹æ•°æ® m æ¥è¯»æ•°æ®å€¼ï¼Œç„¶åæœ‰é€šè¿‡åŸå§‹æ•°æ® m è®¾ç½®æ•°æ®å€¼ï¼Œæ­¤æ—¶å‘ç°å‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œäº†ã€‚è¿™å…¶å®ä¸æ˜¯æˆ‘ä»¬æ‰€æœŸæœ›çš„è¡Œä¸ºï¼Œå› ä¸ºåŸå§‹æ•°æ®ä¸åº”è¯¥å…·æœ‰å“åº”å¼æ•°æ®çš„èƒ½åŠ›ï¼Œå¦åˆ™å°±æ„å‘³ç”¨æˆ·æ—¢å¯ä»¥æ“ä½œåŸå§‹æ•°æ®ï¼Œæœ‰èƒ½å¤Ÿæ“ä½œå“åº”å¼æ•°æ®ï¼Œè¿™æ ·ä¾èµ–ä»£ç å°±ä¹±å¥—äº†ã€‚

é‚£ä¹ˆï¼Œå¯¼è‡´é—®é¢˜çš„åŸå› æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ å…¶å®å¾ˆç®€å•ï¼Œè§‚å¯Ÿæˆ‘ä»¬å‰é¢å®ç°çš„ set æ–¹æ³•:

```js
const mutableInstrumentations = {
	set(key, value) {
		const target = this.raw
		const had = target.has(key)
		const oldValue = target.get(key)
		// æˆ‘ä»¬æŠŠ value åŸå°ä¸åŠ¨åœ°è‰²å·å“ˆå“ˆå“ˆå“ˆåªåˆ°åŸå§‹æ•°æ®ä¸Š
		target.set(key, value)
		if (!had) {
			trigger(target, key, "ADD")
		} else if (oldValue !== value || (oldValue === oldValue && value === value)) {
			trigger(target, key, "SET")
		}
	}
}
```

åœ¨ set æ–¹æ³•å†…ï¼Œæˆ‘ä»¬å§ value åŸæ ·è®¾ç½®åˆ°äº†åŸå§‹æ•°æ® target ä¸Šã€‚å¦‚æœ value æ˜¯å“åº”å¼æ•°æ®ï¼Œå°±æ„å‘³ç€è®¾ç½®åˆ°åŸå§‹å¯¹è±¡ä¸Šçš„ä¹Ÿæ˜¯å“åº”å¼æ•°æ®ï¼Œæˆ‘ä»¬æŠŠ**å“åº”å¼æ•°æ®è®¾ç½®åˆ°åŸå§‹æ•°æ®ä¸Šçš„è¡Œä¸ºç§°ä¸ºæ•°æ®æ±¡æŸ“**ã€‚

è¦è§£å†³æ•°æ®æ±¡æŸ“ä¹Ÿä¸éš¾ï¼Œ åªéœ€è¦åœ¨è°ƒç”¨ target.get å‡½æ•°è®¾ç½®å€¼ä¹‹å‰å¯¹å€¼è¿›è¡Œæ£€æŸ¥å³å¯: åªè¦å‘ç°å³å°†è¦è®¾ç½®çš„å€¼æ˜¯å“åº”å¼æ•°æ®ï¼Œé‚£ä¹ˆå°±é€šè¿‡ raw å±æ€§è·å–åŸå§‹æ•°æ®ï¼Œå†æŠŠåŸå§‹æ•°æ®è®¾ç½®åˆ° target ä¸Šï¼Œå¦‚æœä¸‹é¢çš„ä»£ç æ‰€ç¤º:

```js
const mutableInstrumentations = {
	set(key, value) {
		const target = this.raw
		const had = target.has(key)
		const oldValue = target.get(key)
		// è·å–åŸå§‹æ•°æ®ï¼Œ ç”±äº value æœ¬èº«å¯èƒ½å·²ç»æ˜¯åŸå§‹æ•°æ®ï¼Œæ‰€ä»¥æ­¤æ—¶ value.raw ä¸å­˜åœ¨ï¼Œåˆ™ç›´æ¥ä½¿ç”¨ value
		const rawValue = value.raw || value
		target.set(key, value)
		if (!had) {
			trigger(target, key, "ADD")
		} else if (oldValue !== value || (oldValue === oldValue && value === value)) {
			trigger(target, key, "SET")
		}
	}
}
```

ç°åœ¨çš„å®ç°ä¸ä¼šé€ æˆæ•°æ®æ±¡æŸ“äº†ã€‚ä¸è¿‡ï¼Œç»†å¿ƒè§‚å¯Ÿä¸Šé¢çš„ä»£ç ï¼Œä¼šå‘ç°æ–°çš„é—®é¢˜ã€‚æˆ‘ä»¬ä¸€ç›´ä½¿ç”¨ raw å±æ€§æ¥è®¿é—®åŸå§‹æ•°æ®æ˜¯æœ‰ç¼ºé™·çš„ï¼Œå› ä¸ºå®ƒå¯èƒ½ä¸ç”¨æˆ·è‡ªå®šä¹‰çš„ raw å±æ€§å†²çªï¼Œæ‰€ä»¥åœ¨ä¸€ä¸ªä¸¥è°¨çš„å®ç°ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨å”¯ä¸€çš„æ ‡è¯†æ¥ä½œä¸ºè®¿é—®åŸå§‹æ•°æ®çš„é”®ï¼Œä¾‹å¦‚ä½¿ç”¨ Symbol ç±»å‹æ¥ä»£æ›¿ã€‚

æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ Map ç±»å‹æ•°æ®çš„ set æ–¹æ³•è®²è§£äº†å…³äºé¿å…æ±¡æŸ“åŸå§‹æ•°æ®çš„é—®é¢˜ã€‚å…¶å®å‡ºäº† set æ–¹æ³•éœ€è¦é¿å…æ±¡æŸ“åŸå§‹æ•°æ®ä¹‹å¤–ï¼ŒSet ç±»å‹çš„ add æ–¹æ³•ã€æ™®é€šå¯¹è±¡çš„å†™å€¼æ“ä½œï¼Œè¿˜æœ‰ä¸ºæ•°ç»„æ·»åŠ å…ƒç´ çš„æ–¹æ³•ç­‰ï¼Œéƒ½éœ€è¦åšç±»ä¼¼çš„å¤„ç†ã€‚

## å¤„ç† forEach

é›†åˆç±»å‹çš„ forEach æ–¹æ³•ç±»ä¼¼äºæ•°ç»„çš„ forEach æ–¹æ³•ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„:

```js
const m = new Map([[{ key: 1 }, { value: 1 }]])

effect(() => {
	m.forEach(function (value, key, m) {
		console.log(value) // { value: 1 }
		console.log(key) // { key: 1 }
	})
})
```

ä»¥ Map ä¸ºä¾‹ï¼ŒforEach æ–¹æ³•æ¥å—ä¸€ä¸ªå›è°ƒå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œè¯¥å›è°ƒå‡½æ•°ä¼šåœ¨ Map çš„æ¯ä¸ªé”®å€¼å¯¹ä¸Šè¢«è°ƒç”¨ã€‚å›è°ƒå‡½æ•°æ¥æ”¶ä¸‰ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯å€¼ã€é”®ã€ä»¥åŠåŸå§‹ Map å¯¹è±¡ã€‚å¦‚ä¸Šé¢çš„ä»£ç æ‰€ç¤ºï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ forEach æ–¹æ³•éå† Map æ•°æ®çš„æ¯ä¸€ç»„é”®å€¼å¯¹ã€‚

éå†æ“ä½œåªä¸é”®å€¼å¯¹çš„æ•°é‡æœ‰å…³ï¼Œå› æ­¤ä»»ä½•ä¼šä¿®æ”¹ Map å¯¹è±¡é”®å€¼å¯¹æ•°é‡çš„æ“ä½œéƒ½åº”è¯¥è§¦å‘å‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œï¼Œä¾‹å¦‚ delete å’Œ add æ–¹æ³•ç­‰ã€‚æ‰€ä»¥å½“ forEach å‡½æ•°è¢«è°ƒç”¨æ—¶ï¼Œæˆ‘ä»¬åº”è¯¥è®©å‰¯ä½œç”¨å‡½æ•°ä¸ ITERATE_KEY å»ºç«‹å“åº”è”ç³»ï¼Œå¦‚ä¸‹é¢çš„ä»£ç æ‰€ç¤º:

```js
const mutableInstrumentations = {
	forEach(callback) {
		// å–å¾—åŸå§‹æ•°æ®å¯¹è±¡
		const target = this.raw
		// ä¸ ITERATE_KEY å»ºç«‹å“åº”è”ç³»
		track(target, ITERATE_KEY)
		// é€šè¿‡åŸå§‹æ•°æ®å¯¹è±¡è°ƒç”¨ forEach æ–¹æ³•ï¼Œå¹¶æŠŠcallbackä¼ é€’è¿‡å»
		target.forEach(callback)
	}
}
```

è¿™æ ·æˆ‘ä»¬å°±å®ç°äº†å¯¹ forEach æ“ä½œçš„è¿½è¸ªï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢ä»£ç è¿›è¡Œæµ‹è¯•ï¼š

```js
const p = reactive(new Map([[{ key: 1 }, { value: 1 }]]))

effect(() => {
	p.forEach(function (value, key, m) {
		console.log(value) // { value: 1 }
		console.log(key) //  { key: 1 }
	})
})

// èƒ½å¤Ÿè§¦å‘å“åº”
p.set({ key: 2 }, { value: 2 })
```

å¯ä»¥å‘ç°ï¼Œè¿™æ®µä»£ç èƒ½å¤ŸæŒ‰ç…§é¢„æœŸå·¥ä½œã€‚ç„¶è€Œï¼Œä¸Šé¢ç»™å‡ºçš„ forEach å‡½æ•°ä»ç„¶å­˜åœ¨ç¼ºé™·ï¼Œæˆ‘ä»¬åœ¨è‡ªå®šä¹‰å®ç°çš„ forEach æ–¹æ³•å†…ï¼Œé€šè¿‡åŸå§‹å¯¹è±¡è°ƒç”¨äº†åŸç”Ÿçš„ forEach æ–¹æ³•ï¼Œå³

```js
// é€šè¿‡åŸå§‹æ•°æ®å¯¹è±¡è°ƒç”¨ forEach æ–¹æ³•ï¼Œå¹¶æŠŠ callback ä¼ é€’è¿‡å»
target.forEach(callback)
```

è¿™æ„å‘³ç€ï¼Œ ä¼ é€’ç»™ callback å›è°ƒå‡½æ•°çš„å‚æ•°å°†æ˜¯éå“åº”å¼æ•°æ®ã€‚è¿™å¯¼è‡´ä¸‹é¢çš„ä»£ç ä¸èƒ½æŒ‰é¢„æœŸå·¥ä½œ:

```js
const key = { key: 1 }
const value = new Set([1, 2, 3])

const p = reactive(new Map([[key, value]]))

effect(() => {
	p.forEach(function (value, key) {
		console.log(value.size) // 3
	})
})

p.get(key).delete(1)
```

åœ¨ä¸Šé¢è¿™æ®µä»£ç ä¸­ï¼Œå“åº”å¼æ•°æ® p æœ‰ä¸€ä¸ªé”®å€¼å¯¹ï¼Œå…¶ä¸­é”®æ˜¯æ™®é€šå¯¹è±¡{key:1},å€¼æ˜¯ Set ç±»å‹çš„åŸå§‹æ•°æ® new Set([1, 2, 3])ã€‚æ¥ç€ï¼Œæˆ‘ä»¬åœ¨å‰¯ä½œç”¨å‡½æ•°ä¸­ä½¿ç”¨ forEach æ–¹æ³•éå† pï¼Œå¹¶åœ¨å›è°ƒå‡½æ•°ä¸­è®¿é—® value.sizeã€‚æœ€åï¼Œæˆ‘ä»¬å°è¯•åˆ é™¤ Set ç±»å‹æ•°æ®ä¸­å€¼ä¸º 1 çš„å…ƒç´ ï¼Œå´å‘ç°æ²¡èƒ½è§¦å‘å‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œã€‚å¯¼è‡´é—®é¢˜çš„åŸå› å°±åœ¨ä¸Šé¢æ›¾æåˆ°ï¼Œå½“é€šè¿‡ value.size è®¿é—® size å±æ€§æ—¶ï¼Œè¿™é‡Œçš„ value æ˜¯åŸå§‹æ•°æ®å¯¹è±¡ï¼Œå³ new Set([1, 2, 3])ï¼Œè€Œéå“åº”å¼æ•°æ®å¯¹è±¡ï¼Œå› æ­¤æ— æ³•å»ºç«‹å“åº”è”ç³»ã€‚ä½†è¿™å…¶å®ä¸ç¬¦åˆç›´è§‰ï¼Œå› ä¸º reactive æœ¬èº«æ˜¯æ·±å“åº”ï¼ŒforEach æ–¹æ³•çš„å›è°ƒå‡½æ•°æ‰€æ¥æ”¶åˆ°çš„å‚æ•°ä¹Ÿåº”è¯¥æ˜¯å“åº”å¼æ•°æ®æ‰å¯¹ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦å¯¹ç°æœ‰å®ç°åšä¸€äº›ä¿®æ”¹ï¼Œå¦‚ä¸‹é¢çš„ä»£ç æ‰€ç¤º:

```js
const mutableInstrumentations = {
	forEach(callback) {
		// wrap å‡½æ•°ç”¨æ¥æŠŠå¯ä»£ç†çš„å€¼è½¬æ¢ä¸ºå“åº”å¼æ•°æ®
		const wrap = (val) => (typeof val === "object" ? reactive(val) : val)
		// å–å¾—åŸå§‹æ•°æ®å¯¹è±¡
		const target = this.raw
		// ä¸ ITERATE_KEY å»ºç«‹å“åº”è”ç³»
		track(target, ITERATE_KEY)
		// é€šè¿‡ target è°ƒç”¨åŸå§‹ forEach æ–¹æ³•éå†
		target.forEach((v, k) => {
			// æ‰‹åŠ¨è°ƒç”¨ callback, ç”¨ wrap å‡½æ•°åŒ…è£¹ value å’Œ key å†ä¼ ç»™ callback
			callback(wrap(v), wrap(k), this)
		})
	}
}
```

æ€è·¯å¾ˆç®€å•ï¼Œå¯¹ callback å‚æ•°åšäº†ä¸€å±‚åŒ…è£…ï¼Œå³æŠŠä¼ é€’ç»™ callback å‡½æ•°çš„å‚æ•°åŒ…è£…æˆå“åº”å¼çš„ã€‚æ­¤æ—¶ï¼Œå¦‚æœå†æ¬¡å°è¯•è¿è¡Œå‰é¢çš„ä¾‹å­ï¼Œä¼šå‘ç°èƒ½å¤ŸæŒ‰ç…§é¢„æœŸå…±å·¥ä½œäº†ã€‚

æœ€åï¼Œå¤„äºä¸¥è°¨æ€§ï¼Œè¿˜éœ€è¦åšä¸€äº›è¡¥å……ã€‚å› ä¸º forEach å‡½æ•°å¤„äº†æ¥æ”¶ callback ä½œä¸ºå‚æ•°ä¹‹å¤–ï¼Œå®ƒè¿˜æ¥æ”¶ç¬¬äºŒä¸ªå‚æ•°ï¼Œè¯¥å‚æ•°å¯ä»¥ç”¨æ¥æŒ‡å®š callback å‡½æ•°æ‰§è¡Œæ—¶çš„ this å€¼ã€‚æ›´åŠ å®Œå–„çš„å®åŠ›å¦‚ä¸‹:

```js
const mutableInstrumentations = {
	// æ¥æ”¶ç¬¬äºŒä¸ªå‚æ•°
	forEach(callback, thisArg) {
		const wrap = (val) => (typeof val === "object" ? reactive(val) : val)
		const target = this.raw
		track(target, ITERATE_KEY)
		target.forEach((v, k) => {
			// é€šè¿‡ .call è°ƒç”¨ callback,å¹¶ä¼ é€’ thisArg
			callback.call(thisArg, wrap(v), wrap(k), this)
		})
	}
}
```

è‡³æ­¤ï¼Œæˆ‘ä»¬çš„å·¥ä½œä»ç„¶æ²¡æœ‰å®Œæˆã€‚ç°åœ¨æˆ‘ä»¬çŸ¥é“ï¼Œæ— è®ºæ˜¯ä½¿ç”¨ for...in å¾ªç¯éå†ä¸€ä¸ªå¯¹è±¡ï¼Œè¿˜æ˜¯ä½¿ç”¨ forEach å¾ªç¯éå†ä¸€ä¸ªé›†åˆï¼Œå®ƒä»¬çš„å“åº”è”ç³»éƒ½æ˜¯å»ºç«‹åœ¨ ITERATE_KEY ä¸å‰¯ä½œç”¨å‡½æ•°ä¹‹é—´çš„ã€‚ç„¶è€Œï¼Œä½¿ç”¨ for...in æ¥éå†å¯¹è±¡ä¸ä½¿ç”¨ forEach éå†é›†åˆä¹‹é—´å­˜åœ¨æœ¬è´¨çš„ä¸åŒã€‚å…·ä½“ä½“ç°åœ¨ï¼Œå½“ä½¿ç”¨ for...in å¾ªç¯éå†å¯¹è±¡æ—¶ï¼Œå®ƒå€¼å…³å¿ƒå¯¹è±¡çš„é”®ï¼Œè€Œä¸å…³å¿ƒå¯¹è±¡çš„å€¼ï¼Œå¦‚ä»¥ä¸‹ä»£ç æ‰€ç¤º:

```js
effect(() => {
	for (const key in obj) {
		console.log(key)
	}
})
```

åªæœ‰å½“æ–°å¢ã€åˆ é™¤å¯¹è±¡çš„ key æ—¶ï¼Œæ‰éœ€è¦é‡æ–°æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°ã€‚æ‰€ä»¥æˆ‘ä»¬åœ¨ trigger å‡½æ•°å†…åˆ¤æ–­æ“ä½œç±»å‹æ˜¯å¦æ˜¯ ADD æˆ– DELETE,è¿›è€ŒçŸ¥é“æ˜¯å¦éœ€è¦è§¦å‘é‚£äº›ä¸ ITERATE_KEY ç›¸å…³è”çš„å‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œã€‚å¯¹äº SET ç±»å‹çš„æ“ä½œæ¥è¯´ï¼Œå› ä¸ºå®ƒä¸ä¼šæ”¹å˜ä¸€ä¸ªå¯¹è±¡çš„é”®çš„æ•°é‡ï¼Œæ‰€ä»¥å½“ SET ç±»å‹çš„æ“ä½œå‘ç”Ÿæ—¶ï¼Œä¸éœ€è¦è§¦å‘å‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œã€‚

ä½†è¿™ä¸ªè§„åˆ™ä¸é€‚ç”¨ Map ç±»å‹çš„ forEach éå†ï¼Œå¦‚ä»¥ä¸‹ä»£ç æ‰€ç¤º:

```js
const p = reactive(new Map([["key", 1]]))

effect(() => {
	p.forEach(function (value, key) {
		// forEach å¾ªç¯ä¸ä»…å…³å¿ƒé›†åˆçš„é”®ï¼Œè¿˜å…³å¿ƒé›†åˆçš„å€¼
		console.log(value) // 1
	})
})

p.set("key", 2) // å³ä½¿æ“ä½œç±»å‹æ—¶ SETï¼Œä¹Ÿåº”è¯¥è§¦å‘å“åº”
```

å½“ä½¿ç”¨ forEach éå† Map ç±»å‹çš„æ•°æ®æ—¶ï¼Œå®ƒæ—¢å…³å¿ƒé”®ï¼Œåˆå…³å¿ƒå€¼ã€‚è¿™æ„å‘³ç€ï¼Œå½“è°ƒç”¨ p.set('key','2')ä¿®æ”¹å€¼çš„æ—¶å€™ï¼Œä¹Ÿåº”è¯¥è§¦å‘å‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œï¼Œå³ä½¿å®ƒçš„æ“ä½œç±»å‹æ—¶ SETã€‚å› æ­¤ï¼Œæˆ‘ä»¬åº”è¯¥ä¿®æ”¹ trigger å‡½æ•°çš„ä»£ç æ¥å¼¥è¡¥è¿™ä¸ªç¼ºé™·:

```js
// ä¾èµ–è§¦å‘
function trigger(target, key, type, newVal = undefined) {
	console.log("trigger", key)
	const depsMap = bucket.get(target)

	if (!depsMap) return true

	const effects = depsMap.get(key)

	const iterateEffects = depsMap.get(ITERATE_KEY)

	const effectsToRun: Set<any> = new Set()

	effects &&
		effects.forEach((effectFn) => {
			if (effectFn !== activeEffect) {
				effectsToRun.add(effectFn)
			}
		})

	if (
		type === "ADD" ||
		type === "DELETE" ||
		// å¦‚æœæ“ä½œç±»å‹æ˜¯SETï¼Œå¹¶ä¸”ç›®æ ‡å¯¹è±¡æ˜¯Mapç±»å‹çš„æ•°æ®,
		// ä¹Ÿåº”è¯¥è§¦å‘é‚£äº›ä¸ ITERATE_KEY ç›¸å…³è”çš„å‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œ
		(type === "SET" && Object.prototype.toString.call(target) === "[object Map]")
	) {
		iterateEffects &&
			iterateEffects.forEach((effectFn) => {
				if (effectFn !== activeEffect) {
					effectsToRun.add(effectFn)
				}
			})
	}

	// çœç•¥éƒ¨åˆ†å†…å®¹

	effectsToRun.forEach((effectFn) => {
		if (effectFn.options.scheduler) {
			effectFn.options.scheduler(effectFn)
		} else {
			effectFn()
		}
	})
}
```

å¦‚ä¸Šé¢çš„ä»£ç æ‰€ç¤ºï¼Œ æˆ‘ä»¬å¢åŠ äº†ä¸€ä¸ªåˆ¤æ–­æ¡ä»¶: å¦‚æœæ“ä½œçš„ç›®æ ‡å¯¹è±¡æ˜¯ Map ç±»å‹çš„ï¼Œåˆ™ SET ç±»å‹çš„æ“ä½œä¹Ÿåº”è¯¥è§¦å‘é‚£äº›ä¸ ITERATE_KEY ç›¸å…³è”çš„å‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œã€‚

## è¿­ä»£å™¨æ–¹æ³•

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è®¨è®ºå…³æœºé›†åˆç±»å‹çš„è¿­ä»£å™¨æ–¹æ³•ï¼Œå®é™…ä¸Šå‰é¢è®²è§£å¦‚ä½•æ‹¦æˆª for...of å¾ªç¯éå†æ•°ç»„çš„æ—¶å€™ä»‹ç»è¿‡è¿­ä»£å™¨çš„ç›¸å…³çŸ¥è¯†ã€‚é›†åˆç±»å‹æœ‰ä¸‰ä¸ªè¿­ä»£å™¨æ–¹æ³•ï¼š

- entries
- keys
- values

è°ƒç”¨è¿™äº›æ–¹æ³•ä¼šå¾—åˆ°ç›¸åº”çš„è¿­ä»£å™¨ï¼Œå¹¶ä¸”å¯ä»¥ä½¿ç”¨ for...of è¿›è¡Œå¾ªç¯è¿­ä»£ï¼Œä¾‹å¦‚:

```js
const m = new Map([["key1", "value1"][("key2", "value2")]])

for (const [key, value] of m.entries()) {
	console.log(key, value)
}

// è¾“å‡º:
// key1 value1
// key2 value2
```

å¦å¤–ï¼Œ ç”±äº Map æˆ– Set ç±»å‹æœ¬èº«éƒ¨ç½²äº† Symbol.iterator æ–¹æ³•ï¼Œå› æ­¤å®ƒä»¬å¯ä»¥ä½¿ç”¨ for...of è¿›è¡Œè¿­ä»£:

```js
for(const [key,value] m) {
	console.log(key,value)
}

// è¾“å‡º:
// key1 value1
// key2 value2

```

å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è°ƒç”¨è¿­ä»£å™¨å‡½æ•°å–å¾—è¿­ä»£å™¨å¯¹è±¡åï¼Œæ‰‹åŠ¨è°ƒç”¨è¿­ä»£å™¨å¯¹è±¡çš„ next æ–¹æ³•è·å–å¯¹åº”çš„å€¼:

```js
const itr = m[Symbol.iterator]()

console.log(itr.next()) // { value: ['key1', 'value1'], done: false }
console.log(itr.next()) // { value: ['key2', 'value2'], done: false }
console.log(itr.next()) // { value: undefined, done: true }
```

å®é™…ä¸Šï¼Œ m[Symbol.iterator] ä¸ m.entries æ˜¯ç­‰ä»·çš„:

```js
console.log(m[Symbol.iterator] === m.entries) // true
```

è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä¸Šä¾‹ä¸­ä½¿ç”¨ for...of å¾ªç¯è¿­ä»£ m.entries å’Œ m ä¼šå¾—åˆ°åŒæ ·çš„ç»“æœã€‚

ç†è§£äº†è¿™äº›å†…å®¹ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥å°è¯•å®ç°å¯¹è¿­ä»£å™¨æ–¹æ³•çš„ä»£ç†äº†ï¼Œä¸è¿‡è¿™ä¹‹å‰ï¼Œä¸å¦¨åšä¸€äº›å°è¯•ï¼Œçœ‹çœ‹ä¼šå‘ç”Ÿä»€ä¹ˆï¼Œå¦‚ä»¥ä¸‹ä»£ç æ‰€ç¤º:

```js
const p = reactive(
	new Map([
		["key1", "value1"],
		["key2", "value2"]
	])
)

effect(() => {
	// TypeError: p is not iterable
	for (const [key, value] of p) {
		console.log(key, value)
	}
})

p.set("key3", "value3")
```

åœ¨è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆåˆ›å»ºä¸€ä¸ªä»£ç†å¯¹è±¡ pï¼Œæ¥ç€å°è¯•ä½¿ç”¨ for...of å¾ªç¯éå†å®ƒï¼Œå´å¾—åˆ°äº†ä¸€ä¸ªé”™è¯¯: "p æ˜¯ä¸å¯è¿­ä»£çš„"ã€‚æˆ‘ä»¬çŸ¥é“ä¸€ä¸ªå¯¹è±¡èƒ½å¦è¿­ä»£ï¼Œå–å†³äºè¯¥å¯¹è±¡æ˜¯å¦å®ç°äº†è¿­ä»£åè®®ï¼Œå¦‚æœä¸€ä¸ªå¯¹è±¡æ­£ç¡®åœ°å®ç°äº† Symbol.iterator æ–¹æ³•ï¼Œé‚£ä¹ˆå®ƒå°±æ˜¯å¯è¿­ä»£çš„ã€‚å¾ˆæ˜¾ç„¶ï¼Œä»£ç†å¯¹è±¡ p æ²¡æœ‰å®ç° Symbol.iterator æ–¹æ³•ï¼Œå› æ­¤æˆ‘ä»¬å¾—åˆ°äº†ä¸Šé¢çš„é”™è¯¯ã€‚

ä½†å®é™…ä¸Šï¼Œå½“æˆ‘ä»¬ä½¿ç”¨ for...of å¾ªç¯è¿­ä»£ä¸€ä¸ªä»£ç†å¯¹è±¡æ—¶ï¼Œå†…éƒ¨ä¼šè¯•å›¾ä»ä»£ç†å¯¹è±¡ p ä¸Šè¯»å– p[Symbol.iterator]å±æ€§ï¼Œè¿™ä¸ªæ“ä½œä¼šè§¦å‘ get æ‹¦æˆªå‡½æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬ä»ç„¶å¯ä»¥æŠŠ Symbol.iterator æ–¹æ³•çš„å®ç°æ”¾åˆ° mutableInstrumentations ä¸­ï¼Œå¦‚ä»¥ä¸‹ä»£ç æ‰€ç¤º:

```js
const mutableInstrumentations = {
	[Symbol.iterator]() {
		// è·å–åŸå§‹æ•°æ®å¯¹è±¡
		const target = this.raw
		// è·å–åŸå§‹è¿­ä»£å™¨æ–¹æ³•
		const itr = target[Symbol.iterator]()
		// å°†å…¶è¿”å›
		return itr
	}
}
```

å®ç°å¾ˆç®€å•ï¼Œä¸è¿‡æ˜¯æŠŠåŸå§‹è¿­ä»£å™¨å¯¹è±¡è¿”å›è€Œå·²ï¼Œè¿™æ ·å°±èƒ½å¤Ÿä½¿ç”¨ for...of å¾ªç¯è¿­ä»£ä»£ç†å¯¹è±¡ p äº†ï¼Œç„¶è€Œäº‹æƒ…ä¸å¯èƒ½é‚£ä¹ˆç®€å•ã€‚åœ¨å‰é¢è®²è§£ forEach æ–¹æ³•æ—¶æˆ‘ä»¬æåˆ°è¿‡ï¼Œä¼ é€’ç»™ callback çš„å‚æ•°æ˜¯åŒ…è£…åçš„å“åº”å¼æ•°æ®ï¼Œå¦‚:

```js
p.forEach((value, key) => {
	// value å’Œ key å¦‚æœå¯ä»¥è¢«ä»£ç†ï¼Œ é‚£ä¹ˆå®ƒä»¬å°±æ˜¯ä»£ç†å¯¹è±¡ï¼Œå³å“åº”å¼æ•°æ®
})
```

åŒç†ï¼Œä½¿ç”¨ for...of å¾ªç¯è¿­ä»£é›†åˆæ—¶ï¼Œå¦‚æœè¿­ä»£äº§ç”Ÿçš„å€¼ä¹Ÿæ˜¯å¯ä»¥è¢«ä»£ç†çš„ï¼Œé‚£ä¹ˆä¹Ÿåº”è¯¥å°†å…¶åŒ…è£…æˆå“åº”å¼æ•°æ®ï¼Œä¾‹å¦‚:

```js
const (const [key, value] of p) {
	// æœŸæœ› key å’Œ value æ˜¯å“åº”å¼æ•°æ®
}
```

å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹ä»£ç :

```js
const mutableInstrumentations = {
	[Symbol.iterator]() {
		// è·å–åŸå§‹æ•°æ®å¯¹è±¡
		const target = this.raw
		// è·å–åŸå§‹è¿­ä»£å™¨æ–¹æ³•
		const itr = target[Symbol.iterator]()

		const wrap = (val) => (typeof val === "object" && val !== null ? reactive(val) : val)

		// è¿”å›è‡ªå®šä¹‰çš„è¿­ä»£å™¨
		return {
			next() {
				// è°ƒç”¨åŸå§‹è¿­ä»£å™¨çš„ next æ–¹æ³• è·å–value å’Œ done
				const { value, done } = itr.next()
				return {
					// å¦‚æœ value ä¸æ˜¯ undefined, åˆ™å¯¹å…¶è¿›è¡ŒåŒ…è£¹
					value: value ? [wrap(value[0]), wrap(value[1])] : value,
					done
				}
			}
		}
	}
}
```

å¦‚ä»¥ä¸Šä»£ç æ‰€ç¤ºï¼Œ ä¸ºäº†å®ç°å¯¹ key å’Œ value çš„åŒ…è£…ï¼Œæˆ‘ä»¬éœ€è¦è‡ªå®šä¹‰å®ç°çš„è¿­ä»£å™¨ï¼Œåœ¨å…¶ä¸­è°ƒç”¨åŸå§‹è¿­ä»£å™¨è·å–å€¼ value ä»¥åŠä»£è¡¨æ˜¯å¦ç»“æŸçš„ doneã€‚å¦‚æœå€¼ value ä¸æ˜¯ undefinedï¼Œåˆ™å¯¹å…¶è¿›è¡ŒåŒ…è£…ï¼Œæœ€åè¿”å›åŒ…è£…åçš„ä»£ç†å¯¹è±¡ï¼Œè¿™æ ·å½“ä½¿ç”¨ for...of å¾ªç¯è¿›è¡Œè¿­ä»£æ—¶ï¼Œå¾—åˆ°çš„å€¼å°±ä¼šæ˜¯å“åº”å¼æ•°æ®äº†ã€‚

æœ€åï¼Œä¸ºäº†è¿½è¸ª for...of å¯¹æ•°æ®çš„è¿­ä»£æ“ä½œï¼Œæˆ‘ä»¬è¿˜éœ€è¦è°ƒç”¨ track å‡½æ•°ï¼Œè®©å‰¯ä½œç”¨å‡½æ•°ä¸ ITERATOR_KEY å»ºç«‹è”ç³»:

```js
const mutableInstrumentations = {
	[Symbol.iterator]() {
		// è·å–åŸå§‹æ•°æ®å¯¹è±¡
		const target = this.raw
		// è·å–åŸå§‹è¿­ä»£å™¨æ–¹æ³•
		const itr = target[Symbol.iterator]()

		const wrap = (val) => (typeof val === "object" && val !== null ? reactive(val) : val)

		// è°ƒç”¨ track å‡½æ•°å»ºç«‹å“åº”è”ç³»
		track(target, ITERATOR_KEY)

		// è¿”å›è‡ªå®šä¹‰çš„è¿­ä»£å™¨
		return {
			next() {
				// è°ƒç”¨åŸå§‹è¿­ä»£å™¨çš„ next æ–¹æ³• è·å–value å’Œ done
				const { value, done } = itr.next()
				return {
					// å¦‚æœ value ä¸æ˜¯ undefined, åˆ™å¯¹å…¶è¿›è¡ŒåŒ…è£¹
					value: value ? [wrap(value[0]), wrap(value[1])] : value,
					done
				}
			}
		}
	}
}
```

ç”±äºè¿­ä»£æ“ä½œä¸é›†åˆä¸­å…ƒç´ çš„æ•°é‡æœ‰å…³ï¼Œæ‰€ä»¥åªè¦é›†åˆçš„ size å‘ç”Ÿå˜åŒ–ï¼Œå°±åº”è¯¥è§¦å‘è¿­ä»£æ“ä½œé‡æ–°æ‰§è¡Œã€‚ å› æ­¤ï¼Œæˆ‘ä»¬åœ¨è°ƒç”¨ track å‡½æ•°æ—¶è®© ITERATOR_KEY ä¸å‰¯ä½œç”¨å‡½æ•°å»ºç«‹è”ç³»ã€‚å®Œæˆè¿™ä¸€æ­¥åï¼Œé›†åˆçš„å“åº”å¼æ•°æ®åŠŸèƒ½å°±ç›¸å¯¹å®Œæ•´äº†ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å¦‚æœä¸‹ä»£ç æµ‹è¯•ä¸€ä¸‹:

```js
const p = reactive(
	new Map([
		["key1", "value1"],
		["key2", "value2"]
	])
)

effect(() => {
	for (const [key, value] of p) {
		console.log(key, value)
	}
})

p.set("key3", "value3") // èƒ½å¤Ÿè§¦å‘å“åº”
```

å‰é¢æˆ‘ä»¬è¯´è¿‡ï¼Œç”±äº p.entries ä¸ p[Symbol.iterator]ç­‰ä»·ï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨åŒæ ·çš„ä»£ç æ¥å®ç°å¯¹ p.entries å‡½æ•°çš„æ‹¦æˆªï¼Œå¦‚ä¸€ä¸‹ä»£ç æ‰€ç¤º:

```js
const mutableInstrumentations = {
	// å…¬ç”¨ iterationMethod æ–¹æ³•
	[Symbol.iterator]: iterationMethod,
	entries: iterationMethod
}

// æŠ½ç¦»ä¸ºç‹¬ç«‹çš„å‡½æ•°ï¼Œä¾¿äºå¤ç”¨
function iterationMethod() {
	// è·å–åŸå§‹æ•°æ®å¯¹è±¡
	const target = this.raw
	// è·å–åŸå§‹è¿­ä»£å™¨æ–¹æ³•
	const itr = target[Symbol.iterator]()

	const wrap = (val) => (typeof val === "object" && val !== null ? reactive(val) : val)

	// è°ƒç”¨ track å‡½æ•°å»ºç«‹å“åº”è”ç³»
	track(target, ITERATOR_KEY)

	// è¿”å›è‡ªå®šä¹‰çš„è¿­ä»£å™¨
	return {
		next() {
			// è°ƒç”¨åŸå§‹è¿­ä»£å™¨çš„ next æ–¹æ³• è·å–value å’Œ done
			const { value, done } = itr.next()
			return {
				// å¦‚æœ value ä¸æ˜¯ undefined, åˆ™å¯¹å…¶è¿›è¡ŒåŒ…è£¹
				value: value ? [wrap(value[0]), wrap(value[1])] : value,
				done
			}
		}
	}
}
```

ä½†æ˜¯å½“ä½ å°è¯•è¿è¡Œä»£ç ä½¿ç”¨ for...of è¿›è¡Œè¿­ä»£æ—¶ï¼Œä¼šå¾—åˆ°ä¸€ä¸ªé”™è¯¯:

```js
// TypeError: p.entries is not a function or its return value is not iterable
for (const [key, value] of p.entries()) {
	console.log(key, value)
}
```

é”™è¯¯çš„å¤§æ„æ˜¯ p.entries çš„è¿”å›å€¼ä¸æ˜¯ä¸€ä¸ªå¯è¿­ä»£å¯¹è±¡ã€‚å¾ˆæ˜¾ç„¶ï¼Œp.entries å‡½æ•°è¿”å›çš„æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œè¯¥å¯¹è±¡å¸¦æœ‰ next æ–¹æ³•ï¼Œä½†ä¸å…·æœ‰ Symbol.iterator æ–¹æ³•ï¼Œå› æ­¤å®ƒç¡®å®ä¸æ˜¯ä¸€ä¸ªå¯è¿­ä»£å¯¹è±¡ã€‚è¿™é‡Œæ˜¯ç»å¸¸å‡ºé”™çš„åœ°æ–¹ï¼Œå¤§å®¶åˆ‡å‹¿æŠŠå¯è¿­ä»£åè®®ä¸è¿­ä»£å™¨åè®®ææ··ã€‚å¯è¿­ä»£åè®®æŒ‡çš„æ˜¯ä¸€ä¸ªå¯¹è±¡å®ç°äº† Symbol.iterator æ–¹æ³•ï¼Œè€Œè¿­ä»£å™¨åè®®æŒ‡çš„æ˜¯ä¸€ä¸ªå¯¹è±¡å®ç°äº† next æ–¹æ³•ã€‚ä½†ä¸€ä¸ªå¯¹è±¡å¯ä»¥åŒæ—¶å®ç°å¯è¿­ä»£åè®®å’Œè¿­ä»£å™¨åè®®ï¼Œä¾‹å¦‚:

```js
const obj = {
	// è¿­ä»£å™¨åè®®
	next() {
		// ...
	}
	// å¯è¿­ä»£åè®®
	[Symbol.iterator]() {
		return this
	}
}
```

æ‰€ä»¥è§£å†³é—®é¢˜çš„æ–¹æ³•ä¹Ÿè‡ªç„¶è€Œç„¶åœ°å‡ºç°äº†:

```js
// æŠ½ç¦»ä¸ºç‹¬ç«‹çš„å‡½æ•°ï¼Œä¾¿äºå¤ç”¨
function iterationMethod() {
	// è·å–åŸå§‹æ•°æ®å¯¹è±¡
	const target = this.raw
	// è·å–åŸå§‹è¿­ä»£å™¨æ–¹æ³•
	const itr = target[Symbol.iterator]()

	const wrap = (val) => (typeof val === "object" && val !== null ? reactive(val) : val)

	// è°ƒç”¨ track å‡½æ•°å»ºç«‹å“åº”è”ç³»
	track(target, ITERATOR_KEY)

	// è¿”å›è‡ªå®šä¹‰çš„è¿­ä»£å™¨
	return {
		next() {
			// è°ƒç”¨åŸå§‹è¿­ä»£å™¨çš„ next æ–¹æ³• è·å–value å’Œ done
			const { value, done } = itr.next()
			return {
				// å¦‚æœ value ä¸æ˜¯ undefined, åˆ™å¯¹å…¶è¿›è¡ŒåŒ…è£¹
				value: value ? [wrap(value[0]), wrap(value[1])] : value,
				done
			}
		},
		// å®ç°å¯è¿­ä»£åè®®
		[Symbol.iterator]() {
			return this
		}
	}
}
```

ç°åœ¨ä¸€åˆ‡éƒ½èƒ½æ­£å¸¸å·¥ä½œäº†ã€‚

## values æ–¹æ³• ä¸ keys æ–¹æ³•

values æ–¹æ³•çš„å®ç°ä¸ entries æ–¹æ³•ç±»ä¼¼ï¼Œä¸åŒçš„æ˜¯ï¼Œå½“ä½¿ç”¨ for...of è¿­ä»£ values æ—¶ï¼Œå¾—åˆ°çš„ä»…ä»…æ˜¯ Map æ•°æ®çš„å€¼ï¼Œè€Œéé”®å€¼å¯¹:

```js
for (const value of p.values()) {
	console.log(value)
}
```

values æ–¹æ³•çš„å®ç°å¦‚ä¸‹:

```js
const mutableInstrumentations = {
	// å…±ç”¨ iterationMethod æ–¹æ³•
	[Symbol.iterator]: iterationMethod,
	entries: iterationsMethod,
	values: valuesIterationMethod
}

function valuesIterationMethod() {
	// è·å–åŸå§‹æ•°æ®å¯¹è±¡ target
	const target = this.raw
	// é€šè¿‡ target.values è·å–åŸå§‹è¿­ä»£å™¨æ–¹æ³•
	const itr = target.values()

	const wrap = (val) => (typeof val === "object" ? reactive(val) : val)

	track(target, ITERATOR_KEY)

	// å°†å…¶è¿”å›
	return {
		next() {
			const { value, done } = itr.next()

			return {
				// value æ˜¯å€¼ï¼Œ è€Œéé”®å€¼å¯¹ï¼Œ æ‰€ä»¥åªéœ€è¦åŒ…è£¹ value å³å¯
				value: wrap(value),
				done
			}
		},

		[Symbol.iterator]() {
			return this
		}
	}
}
```

å…¶ä¸­ï¼ŒvaluesIterationMethod ä¸ iterationMethod è¿™ä¸¤ä¸ªæ–¹æ³•æœ‰ä¸¤ç‚¹åŒºåˆ«:

- iterationMethod é€šè¿‡ target[Symbol.iterator]è·å–è¿­ä»£å™¨å¯¹è±¡ï¼Œè€Œ valueIterationMethod é€šè¿‡ target.values è·å–è¿­ä»£å™¨å¯¹è±¡;
- iterationMethod å¤„ç†çš„æ˜¯é”®å€¼å¯¹ï¼Œå³ [Wrap(value[0]), wrap(value[1])], è€Œ valuesIterationMethod åªå¤„ç†å€¼ï¼Œå³ wrap(value)ã€‚

ç”±äºå®ƒä»¬çš„å¤§éƒ¨åˆ†é€»è¾‘ç›¸åŒï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å°†å®ƒä»¬å°è£…åˆ°ä¸€ä¸ªå®¢æœç”¨çš„å‡½æ•°ä¸­ã€‚ä½†ä¸ºäº†ä¾¿äºç†è§£ï¼Œè¿™é‡Œä»ç„¶å°†å®ƒä»¬è®¾è®¡ä¸ºä¸¤ä¸ªç‹¬ç«‹çš„å‡½æ•°æ¥å®ç°ã€‚

keys æ–¹æ³•ä¸ values æ–¹æ³•éå¸¸ç±»ä¼¼ï¼Œä¸åŒç‚¹åœ¨äºï¼Œå‰è€…å¤„ç†çš„æ˜¯é”®è€Œéå€¼ã€‚å› æ­¤ï¼Œæˆ‘ä»¬åªéœ€è¦ä¿®æ”¹ valuesIterationMethod æ–¹æ³•ä¸­çš„ä¸€è¡Œä»£ç ï¼Œå³å¯å®ç°å¯¹ keys æ–¹æ³•çš„ä»£ç†ã€‚æŠŠä¸‹é¢è¿™å¥ä»£ç :

```js
const itr = target.values()
```

æ›¿æ¢æˆ:

```js
const itr = target.keys()
```

è¿™ä¹ˆåšçš„ç¡®èƒ½å¤Ÿè¾¾åˆ°ç›®çš„ï¼Œä½†å¦‚æœæˆ‘ä»¬å°è¯•è¿è¡Œå¦‚ä¸‹æµ‹è¯•ç”¨ä¾‹ï¼Œå°±ä¼šå‘ç°å­˜åœ¨ç¼ºé™·:

```js
const p = reactive(
	new Map([
		["key1", "value1"],
		["key2", "value2"]
	])
)

effect(() => {
	for (const value of p.keys()) {
		console.log(value) // key1 key2
	}
})

p.set("key2", "value3") // è¿™æ˜¯ä¸€ä¸ª SET ç±»å‹æ“ä½œï¼Œ å®ƒä¿®æ”¹äº† key2çš„å€¼
```

åœ¨ä¸Šé¢è¿™æ®µä»£ç ä¸­ï¼Œ æˆ‘ä»¬ä½¿ç”¨äº† for...of å¾ªç¯æ¥éå† p.keys,ç„¶åè°ƒç”¨ p.set('key2','value3')ä¿®æ”¹é”®ä¸º key2 çš„å€¼ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼ŒMap ç±»å‹æ•°æ®çš„æ‰€æœ‰é”®éƒ½æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œä»ç„¶æ˜¯ key1 å’Œ key2ï¼Œæ‰€ä»¥åœ¨ç†æƒ³æƒ…å†µä¸‹ï¼Œå‰¯ä½œç”¨å‡½æ•°ä¸åº”è¯¥æ‰§è¡Œã€‚ä½†å¦‚æœä½ å°è¯•è¿è¡Œä¸Šä¾‹ï¼Œä¼šå‘ç°å‰¯ä½œç”¨å‡½æ•°ä»ç„¶é‡æ–°æ‰§è¡Œäº†ã€‚

è¿™æ˜¯å› ä¸ºï¼Œæˆ‘ä»¬å¯¹ Map ç±»å‹çš„æ•°æ®è¿›è¡Œäº†ç‰¹æ®Šå¤„ç†ã€‚å‰æ–‡æåˆ°ï¼Œå³ä½¿æ“ä½œç±»å‹ä¸º SETï¼Œä¹Ÿä¼šè§¦å‘é‚£äº›ä¸ ITERATOR_KEY ç›¸å…³è”çš„å‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œï¼Œ
trigger å‡½æ•°çš„å¸¦ä¹ˆå¯ä»¥è¯æ˜è¿™ä¸€ç‚¹:

```js
function trigger(target, key, type, newVal) {
	// çœç•¥å…¶ä»–ä»£ç 

	if (
		type === "ADD" ||
		type === "DELETE" ||
		// å³ä½¿æ˜¯ SET ç±»å‹çš„æ“ä½œï¼Œä¹Ÿä¼šè§¦å‘é‚£äº›ä¸ ITERATE_KEY ç›¸å…³è”çš„å‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œ
		(type === "SET" && Object.prototype.toString.call(target) === "[object Map]")
	) {
		const iterateEffects = depsMap.get(ITERATE_KEY)
		iterateEffects &&
			iterateEffects.forEach((effectFn) => {
				if (effectFn !== activeEffect) {
					effectsToRun.add(effectFn)
				}
			})
	}

	// çœç•¥å…¶ä»–ä»£ç 
}
```

è¿™å¯¹äº values æˆ– entries ç­‰æ–¹æ³•æ¥è¯´æ˜¯å¿…é¡»çš„ï¼Œä½†å¯¹äº keys æ–¹æ³•æ¥è¯´åˆ™æ²¡æœ‰å¿…è¦ï¼Œå› ä¸º keys æ–¹æ³•åªå…³å¿ƒ Map ç±»å‹æ•°æ®çš„é”®çš„å˜åŒ–ï¼Œè€Œä¸å…³å¿ƒå€¼çš„å˜åŒ–ã€‚

è§£å†³åŠæ³•å¾ˆç®€å•ï¼Œå¦‚ä»¥ä¸‹ä»£ç æ‰€ç¤º:

```js
const MAP_KEY_ITERATE_KEY = symbol()

function keyIterationMethod() {
	// è·å–åŸå§‹å¯¹è±¡ target
	const target = this.raw
	// è·å–åŸå§‹è¿­ä»£å™¨æ–¹æ³•
	const itr = target.keys()

	const wrap = (val) => (typeof val === "object" ? reactive(val) : val)

	// è°ƒç”¨ track å‡½æ•°è¿½è¸ªä¾èµ–ï¼Œ åœ¨å‰¯ä½œç”¨å‡½æ•°ä¸ MAP_KEY_ITERATE_KEY ä¹‹é—´å»ºç«‹å“åº”è”ç³»
	track(target, MAP_KEY_ITERATE_KEY)

	// å°†å…¶è¿”å›
	return {
		next() {
			const { value, done } = itr.next()
			return {
				value: wrap(value),
				done
			}
		},
		[Symbol.iterator]() {
			return this
		}
	}
}
```

åœ¨ä¸Šé¢è¿™æ®µä»£ç ä¸­ï¼Œå½“è°ƒç”¨ track å‡½æ•°è¿½è¸ªä¾èµ–æ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨ MAP_KEY_ITERATE_KEY ä»£æ›¿äº† ITERATOR_KEYã€‚å…¶ä¸­ MAP_KEY_ITERATE_KEY ä¸ ITERATOR_KEY ç±»ä¼¼ï¼Œæ˜¯ä¸€ä¸ªæ–°çš„ Symbol ç±»å‹ï¼Œç”¨æ¥ä½œä¸ºæŠ½è±¡çš„é”®ã€‚è¿™æ ·å°±å®ç°äº†ä¾èµ–æ”¶é›†çš„åˆ†ç¦»ï¼Œå³ values å’Œ entries ç­‰æ–¹æ³•ä»ç„¶ä¾èµ– ITERATOR_KEY,è€Œ keys æ–¹æ³•åˆ™ä¾èµ– MAP_KEY_ITERATE_KEYã€‚å½“ SET ç±»å‹çš„æ“ä½œåªä¼šè§¦å‘ä¸ ITERATOR_KEY ç›¸å…³è”çš„å‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œæ—¶,è‡ªç„¶å°±ä¼šå¿½ç•¥é‚£äº›ä¸ MAP_KEY_ITERATE_KEY ç›¸å…³è”çš„å‰¯ä½œç”¨å‡½æ•°ã€‚ä½†å½“ ADD å’Œ DELETE ç±»å‹çš„æ“ä½œå‘ç”Ÿæ—¶ï¼Œè¿˜éœ€è¦è§¦å‘ä¸ MAP_KEY_ITERATE_KEY ç›¸å…³è”çš„å‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ä¿®æ”¹ trigger å‡½æ•°çš„ä»£ç ï¼Œå¦‚ä¸‹æ‰€ç¤º:

```js
function trigger(target, key, type, newVal) {
	// çœç•¥å…¶ä»–ä»£ç 
	if (
		// æ“ä½œç±»å‹ä¸º ADD æˆ– DELETE
		(type === "ADD" || type === "DELETE") &&
		// å¹¶ä¸”æ˜¯ Map ç±»å‹çš„æ•°æ®
		Object.prototype.toString.call(target) === "[object Map]"
	) {
		// åˆ™å–å‡ºé‚£äº›ä¸ MAP_KEY_ITERATE_KEY ç›¸å…³è”çš„å‰¯ä½œç”¨å‡½æ•°å¹¶æ‰§è¡Œ
		const iterateEFfects = depsMap.get(MAP_KEY_ITERATE_KEY)
		iterateEffects &&
			iterateEffects.forEach((effectFn) => {
				if (effectFn !== activeEffect) {
					effectToRun.add(effectFn)
				}
			})
	}

	// çœç•¥å…¶ä»–ä»£ç 
}
```

è¿™æ ·å°±èƒ½å¤Ÿé¿å…ä¸å¿…è¦çš„æ›´æ–°äº†:

```js
const p = reactive(
	new Map([
		["key1", "value1"],
		["key2", "value2"]
	])
)

effect(() => {
	for (const value of p.keys()) {
		console.log(value)
	}
})

p.set("key2", "value3") // ä¸ä¼šè§¦å‘å“åº”
p.set("key3", "value3") // èƒ½å¤Ÿè§¦å‘å“åº”
```

